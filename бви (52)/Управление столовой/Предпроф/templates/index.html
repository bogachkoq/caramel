<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–∏—Ç–∞–Ω–∏–µ+ | –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .scroll-custom::-webkit-scrollbar { width: 4px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .allergen-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* ===== TOAST –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            max-width: 340px;
            width: 100%;
        }
        .toast {
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 16px;
            color: #fff;
            font-family: inherit;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.22);
            animation: toast-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            overflow: hidden;
        }
        .toast.toast-exit {
            animation: toast-out 0.35s ease-in forwards;
        }
        .toast-success { background: linear-gradient(135deg, #16a34a, #15803d); }
        .toast-error   { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .toast-warning { background: linear-gradient(135deg, #ea580c, #c2410c); }
        .toast-info    { background: linear-gradient(135deg, #2563eb, #1d4ed8); }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
            margin-top: 1px;
        }
        .toast-body .toast-title {
            font-size: 14px;
            font-weight: 800;
            line-height: 1.3;
        }
        .toast-body .toast-desc {
            font-size: 12px;
            opacity: 0.85;
            margin-top: 2px;
            font-weight: 600;
        }
        .toast-close {
            position: absolute;
            top: 10px;
            right: 12px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }
        .toast-close:hover { color: #fff; }
        /* progress bar */
        .toast::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0;
            height: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 0 0 16px 16px;
            animation: toast-bar 3s linear forwards;
        }

        @keyframes toast-in {
            0%  { transform: translateX(120%); opacity: 0; }
            100%{ transform: translateX(0);    opacity: 1; }
        }
        @keyframes toast-out {
            0%  { transform: translateX(0);    opacity: 1; }
            100%{ transform: translateX(120%); opacity: 0; }
        }
        @keyframes toast-bar {
            0%   { width: 100%; }
            100% { width: 0%;   }
        }

        /* ===== –ö–£–ü–õ–ï–ù–û –û–í–ï–†–õ–ï–ô ===== */
        .bought-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(22,163,74,0.95), rgba(21,128,61,0.97));
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: inherit;
            animation: bought-fade-in 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .bought-overlay.fade-out {
            animation: bought-fade-out 0.4s ease-in forwards;
        }
        @keyframes bought-fade-in {
            0%  { opacity: 0; transform: scale(0.92); }
            100%{ opacity: 1; transform: scale(1);    }
        }
        @keyframes bought-fade-out {
            0%  { opacity: 1; transform: scale(1);    }
            100%{ opacity: 0; transform: scale(0.96); }
        }
        .bought-overlay .check-icon {
            width: 72px;
            height: 72px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 14px;
            animation: check-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.15s both;
        }
        .bought-overlay .check-icon i {
            font-size: 32px;
            color: #fff;
        }
        @keyframes check-pop {
            0%   { transform: scale(0); }
            60%  { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .bought-overlay .bought-text {
            color: #fff;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: bought-text-in 0.4s ease 0.25s both;
        }
        .bought-overlay .bought-sub {
            color: rgba(255,255,255,0.75);
            font-size: 13px;
            font-weight: 600;
            margin-top: 4px;
            animation: bought-text-in 0.4s ease 0.35s both;
        }
        @keyframes bought-text-in {
            0%   { opacity: 0; transform: translateY(8px); }
            100% { opacity: 1; transform: translateY(0);   }
        }

        /* ===== –ö–ù–û–ü–ö–ê LOADING ===== */
        .btn-loading {
            position: relative;
            pointer-events: none !important;
            opacity: 0.75 !important;
        }
        .btn-loading .btn-spinner {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-spinner-ring {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .btn-loading .btn-text { visibility: hidden; }

        /* ===== –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï "–Ø –ø–æ–µ–ª(–∞)" ===== */
        .eaten-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(37,99,235,0.95), rgba(29,78,216,0.97));
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            animation: bought-fade-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .eaten-overlay.fade-out {
            animation: bought-fade-out 0.35s ease-in forwards;
        }
        .eaten-overlay i {
            font-size: 28px;
            color: #fff;
            margin-bottom: 6px;
        }
        .eaten-overlay span {
            color: #fff;
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body class="bg-slate-50" x-data="canteenApp()" x-init="init()">

    <!-- ===== TOAST –ö–û–ù–¢–ï–ô–ù–ï–† ===== -->
    <div id="toast-container" class="toast-container"></div>

    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
    <template x-if="!user">
        <div class="fixed inset-0 bg-gradient-to-br from-blue-700 via-blue-800 to-slate-900 flex items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-white p-8 md:p-10 rounded-[2rem] shadow-2xl w-full max-w-lg my-8 transition-all">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 text-white rounded-2xl mb-4 shadow-lg shadow-blue-200">
                        <i class="fas fa-utensils text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">–ü–ò–¢–ê–ù–ò–ï+</h2>
                    <p class="text-slate-400 text-sm font-bold uppercase tracking-widest mt-1" x-text="isRegistering ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'"></p>
                </div>

                <div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-2xl">
                    <button @click="regData.role='student'" :class="regData.role=='student'?'bg-white shadow text-blue-600':''" class="flex-1 py-2.5 rounded-xl font-black text-[10px] uppercase transition-all">–£—á–µ–Ω–∏–∫</button>
                    <button @click="regData.role='chef'" :class="regData.role=='chef'?'bg-white shadow text-blue-600':''" class="flex-1 py-2.5 rounded-xl font-black text-[10px] uppercase transition-all">–ü–æ–≤–∞—Ä</button>
                    <button @click="regData.role='admin'" :class="regData.role=='admin'?'bg-white shadow text-blue-600':''" class="flex-1 py-2.5 rounded-xl font-black text-[10px] uppercase transition-all">–ê–¥–º–∏–Ω</button>
                </div>

                <div class="space-y-3">
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-4 text-slate-300"></i>
                        <input type="text" x-model="regData.username" placeholder="–õ–æ–≥–∏–Ω" class="w-full pl-12 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-bold transition-all">
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-4 text-slate-300"></i>
                        <input type="password" x-model="regData.password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full pl-12 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-bold transition-all">
                    </div>

                    <template x-if="isRegistering">
                        <div class="space-y-3 animate-fade-in">
                            <template x-if="regData.role === 'admin'">
                                <input type="password" x-model="regData.adminKey" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á ROOT-..." class="w-full p-4 bg-orange-50 border border-orange-200 rounded-2xl outline-none focus:border-orange-500 font-bold text-orange-700">
                            </template>
                            <input type="text" x-model="regData.fullName" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-bold">
                            <input type="tel" x-model="regData.phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-bold">

                            <template x-if="regData.role !== 'student'">
                                <input type="email" x-model="regData.email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-bold">
                            </template>

                            <div class="flex gap-3 relative">
                                <template x-if="regData.role == 'student'">
                                    <input type="text" x-model="regData.grade" placeholder="–ö–ª–∞—Å—Å" class="w-1/3 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-bold">
                                </template>
                                <div class="flex-1 relative" @click.away="showSchoolDropdown = false">
                                    <input type="text" x-model="regData.school" @focus="showSchoolDropdown = true" @input="showSchoolDropdown = true" :placeholder="regData.role == 'student' ? '–®–∫–æ–ª–∞ ‚Ññ' : '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-blue-500 font-bold transition-all">
                                    <div x-show="showSchoolDropdown && filteredSchools.length > 0" class="absolute z-50 left-0 right-0 top-full mt-1 bg-white border rounded-2xl shadow-xl max-h-48 overflow-y-auto scroll-custom border-blue-100">
                                        <template x-for="school in filteredSchools">
                                            <div @click="regData.school = school; showSchoolDropdown = false" class="p-3 hover:bg-blue-50 cursor-pointer text-[11px] font-bold border-b last:border-0 border-slate-50 transition-colors" x-text="school"></div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <button @click="isRegistering ? register() : login()"
                        :class="loginLoading ? 'btn-loading' : ''"
                        class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase mt-8 shadow-xl hover:bg-blue-700 transition-all relative"
                        x-text="isRegistering ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏'">
                </button>
                <template x-if="loginLoading">
                    <div class="absolute inset-0 mt-8 h-[52px] flex items-center justify-center pointer-events-none">
                        <div class="btn-spinner-ring"></div>
                    </div>
                </template>
                <div class="text-center mt-6">
                    <button @click="isRegistering = !isRegistering" class="text-slate-400 text-xs font-bold uppercase hover:text-blue-600">
                        <span x-text="isRegistering ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏' : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'"></span>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div x-show="user" class="min-h-screen flex flex-col" x-cloak>
        <header class="bg-white border-b p-4 px-8 flex justify-between items-center sticky top-0 z-40">
            <div class="font-black text-2xl text-blue-800 flex items-center gap-2"><i class="fas fa-utensils"></i> –ü–ò–¢–ê–ù–ò–ï+</div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] font-black text-slate-400 uppercase leading-none" x-text="user?.school"></p>
                    <p class="font-bold text-slate-700" x-text="user?.fullName"></p>
                </div>
                <span class="bg-blue-100 text-blue-700 px-4 py-1 rounded-full text-[10px] font-black uppercase" x-text="user ? user.role : ''"></span>
                <button @click="logout()" class="text-slate-300 hover:text-red-500 text-xl"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div class="flex flex-1">
            <nav class="w-72 bg-white border-r p-6 space-y-2 hidden lg:block">
                <template x-for="item in navItems[user?.role]">
                    <button @click="tab = item.id"
                            :class="tab == item.id ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
                            class="w-full flex items-center gap-3 p-4 rounded-2xl font-bold transition-all relative text-left">
                        <i class="fas w-5" :class="item.icon"></i> <span x-text="item.name"></span>
                        <template x-if="item.id == 'ad_staff' && users.filter(u => u.role == 'chef' && !u.isApproved).length > 0">
                            <span class="absolute right-4 w-2 h-2 bg-orange-500 rounded-full"></span>
                        </template>
                        <template x-if="item.id == 'ad_approve' && purchases.filter(p => p.status == '–û–∂–∏–¥–∞–µ—Ç').length > 0">
                            <span class="absolute right-4 w-2 h-2 bg-orange-500 rounded-full"></span>
                        </template>
                        <template x-if="item.id.includes('notif') && filteredNotifications.length > 0">
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 w-2 h-2 bg-red-500 rounded-full"></span>
                        </template>
                    </button>
                </template>
            </nav>

            <main class="flex-1 p-8 overflow-y-auto">

                <!-- –í–ö–õ–ê–î–ö–ê –ê–î–ú–ò–ù–ê: –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ï–†–°–û–ù–ê–õ–û–ú -->
                <div x-show="tab == 'ad_staff'">
                    <h2 class="text-2xl font-black mb-6 uppercase tracking-tighter">–ó–∞—è–≤–∫–∏ –æ—Ç –ø–æ–≤–∞—Ä–æ–≤</h2>
                    <div class="space-y-4">
                        <template x-for="chef in users.filter(u => u.role == 'chef' && !u.isApproved)">
                            <div class="bg-white p-6 rounded-3xl border flex justify-between items-center shadow-sm border-l-8 border-blue-500">
                                <div>
                                    <b class="text-xl block" x-text="chef.fullName"></b>
                                    <div class="flex gap-4 text-slate-400 text-[10px] font-black uppercase mt-1">
                                        <span><i class="fas fa-school mr-1"></i> <span x-text="chef.school"></span></span>
                                        <span><i class="fas fa-phone mr-1"></i> <span x-text="chef.phone"></span></span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="approveChef(chef.username)"
                                            :class="approveLoading == chef.username ? 'btn-loading' : ''"
                                            class="bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold uppercase text-xs hover:bg-emerald-600 relative">
                                        <span class="btn-text">–û–¥–æ–±—Ä–∏—Ç—å</span>
                                        <template x-if="approveLoading == chef.username">
                                            <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                        </template>
                                    </button>
                                    <button @click="rejectChef(chef.username)"
                                            :class="rejectLoading == chef.username ? 'btn-loading' : ''"
                                            class="bg-red-100 text-red-600 px-6 py-3 rounded-xl font-bold uppercase text-xs hover:bg-red-200 relative">
                                        <span class="btn-text">–£–¥–∞–ª–∏—Ç—å</span>
                                        <template x-if="rejectLoading == chef.username">
                                            <div class="btn-spinner"><div class="btn-spinner-ring" style="border-top-color:#dc2626"></div></div>
                                        </template>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template x-if="users.filter(u => u.role == 'chef' && !u.isApproved).length === 0">
                            <div class="text-center py-20 opacity-30"><i class="fas fa-user-clock text-6xl mb-4"></i><p class="font-black uppercase">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</p></div>
                        </template>
                    </div>
                </div>

                <!-- –í–ö–õ–ê–î–ö–ò –£–ß–ï–ù–ò–ö–ê: –ú–ï–ù–Æ –î–ù–Ø -->
                <div x-show="tab == 'st_menu'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black uppercase">–ú–µ–Ω—é –¥–Ω—è</h2>
                        <div class="flex items-center gap-4">
                            <div class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl font-bold text-sm">
                                –í—Å–µ–≥–æ –±–ª—é–¥: <span x-text="menu.length"></span>
                            </div>
                            <div class="flex gap-2">
                                <button @click="filterMenuCategory = 'all'" :class="filterMenuCategory == 'all' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'" class="px-4 py-2 rounded-xl text-xs font-bold border">–í—Å–µ</button>
                                <button @click="filterMenuCategory = '–ó–∞–≤—Ç—Ä–∞–∫'" :class="filterMenuCategory == '–ó–∞–≤—Ç—Ä–∞–∫' ? 'bg-orange-500 text-white' : 'bg-white text-slate-700'" class="px-4 py-2 rounded-xl text-xs font-bold border">–ó–∞–≤—Ç—Ä–∞–∫–∏</button>
                                <button @click="filterMenuCategory = '–û–±–µ–¥'" :class="filterMenuCategory == '–û–±–µ–¥' ? 'bg-emerald-600 text-white' : 'bg-white text-slate-700'" class="px-4 py-2 rounded-xl text-xs font-bold border">–û–±–µ–¥—ã</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="m in filteredMenu">
                            <div class="bg-white p-6 rounded-3xl border shadow-sm relative overflow-hidden transition-all hover:shadow-md hover:scale-[1.02] duration-300" :class="hasAllergen(m) ? 'border-red-300 border-2' : ''">

                                <!-- –û–í–ï–†–õ–ï–ô "–ó–ê–ö–û–ù–ß–ò–õ–û–°–¨" -->
                                <div x-show="m.portions <= 0 && !boughtDishes[m.id]" class="absolute inset-0 bg-white/90 z-10 flex items-center justify-center">
                                    <span class="bg-red-500 text-white px-4 py-2 rounded-lg font-black uppercase text-xs rotate-12 animate-pulse">–ó–∞–∫–æ–Ω—á–∏–ª–æ—Å—å</span>
                                </div>

                                <!-- –û–í–ï–†–õ–ï–ô "–ö–£–ü–õ–ï–ù–û!" -->
                                <div x-show="boughtDishes[m.id]" class="bought-overlay" :class="boughtDishesExit[m.id] ? 'fade-out' : ''">
                                    <div class="check-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="bought-text">–ö—É–ø–ª–µ–Ω–æ!</div>
                                    <div class="bought-sub" x-text="m.name"></div>
                                </div>

                                <div class="flex justify-between items-start">
                                    <div class="flex gap-2">
                                        <span :class="(m.category || '–û–±–µ–¥') == '–ó–∞–≤—Ç—Ä–∞–∫' ? 'bg-orange-100 text-orange-600' : 'bg-emerald-100 text-emerald-600'" class="px-3 py-1 rounded-lg text-[10px] font-black uppercase" x-text="((m.category || '–û–±–µ–¥') == '–ó–∞–≤—Ç—Ä–∞–∫' ? 'üåÖ ' : 'üçΩÔ∏è ') + (m.category || '–û–±–µ–¥')"></span>
                                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase" x-text="m.type"></span>
                                    </div>
                                    <span x-show="isNewDish(m.addedDate)" class="bg-emerald-100 text-emerald-600 px-2 py-1 rounded text-[9px] font-black uppercase animate-pulse">–ù–û–í–û–ï!</span>
                                </div>
                                <div class="mt-3">
                                    <div class="flex items-start gap-2 flex-wrap">
                                        <h4 class="text-xl font-bold" x-text="m.name"></h4>
                                        <!-- –ö–†–ê–°–ù–´–ï –ë–ï–ô–î–ñ–ò –ê–õ–õ–ï–†–ì–ï–ù–û–í –†–Ø–î–û–ú –° –ù–ê–ó–í–ê–ù–ò–ï–ú -->
                                        <template x-for="allergen in getDetectedAllergens(m)">
                                            <span class="bg-red-600 text-white px-2 py-1 rounded-lg text-[10px] font-black uppercase animate-pulse shadow-lg" x-text="allergen"></span>
                                        </template>
                                    </div>
                                    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –û–ë –ê–õ–õ–ï–†–ì–ï–ù–ï -->
                                    <div x-show="hasAllergen(m)" class="mt-2 bg-red-50 border-2 border-red-500 rounded-xl p-3 allergen-pulse">
                                        <div class="flex items-center gap-2 mb-1">
                                            <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
                                            <span class="text-red-600 font-black uppercase text-sm">‚ö†Ô∏è –û–ü–ê–°–ù–û –î–õ–Ø –í–ê–°</span>
                                        </div>
                                        <p class="text-red-700 font-bold text-xs mt-1">–°–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∞—Å–Ω—ã–µ –¥–ª—è –≤–∞—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã. –£–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∞–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫—É—é —Ä–µ–∞–∫—Ü–∏—é!</p>
                                    </div>
                                </div>
                                <!-- –°–û–°–¢–ê–í –ë–õ–Æ–î–ê -->
                                <div class="mt-3 bg-slate-50 rounded-xl p-3">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-1">–°–æ—Å—Ç–∞–≤:</p>
                                    <p class="text-sm text-slate-600 font-medium" x-text="m.ingredients || '–ù–µ —É–∫–∞–∑–∞–Ω'"></p>
                                </div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase mt-2">
                                    –í –Ω–∞–ª–∏—á–∏–∏: <span :class="m.portions > 5 ? 'text-emerald-600' : 'text-orange-600'" x-text="m.portions"></span> —à—Ç.
                                </p>
                                <div class="flex justify-between mt-6 items-center">
                                    <div>
                                        <span class="text-3xl font-black" x-text="m.price + ' ‚ÇΩ'"></span>
                                        <p class="text-[10px] text-slate-400 mt-1" x-text="'–î–æ–±–∞–≤–ª–µ–Ω–æ: ' + formatDate(m.addedDate)"></p>
                                    </div>
                                    <button @click="buy(m)"
                                            :disabled="m.portions <= 0 || buyingDish == m.id"
                                            :class="[
                                                m.portions <= 0 ? 'bg-slate-300 cursor-not-allowed' : (hasAllergen(m) ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700'),
                                                buyingDish == m.id ? 'btn-loading' : ''
                                            ]"
                                            class="text-white px-6 py-3 rounded-xl font-bold text-xs uppercase shadow-lg transition-all relative">
                                        <span class="btn-text" x-text="hasAllergen(m) ? '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ!' : '–ö—É–ø–∏—Ç—å'"></span>
                                        <template x-if="buyingDish == m.id">
                                            <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                        </template>
                                    </button>
                                </div>
                            </div>
                        </template>

                        <template x-if="filteredMenu.length === 0">
                            <div class="col-span-full text-center py-20">
                                <i class="fas fa-utensils text-6xl text-slate-300 mb-4"></i>
                                <p class="font-black uppercase text-slate-400">–ù–µ—Ç –±–ª—é–¥ –≤ –º–µ–Ω—é</p>
                                <p class="text-slate-400 text-sm mt-2">–ü–æ–≤–∞—Ä –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –±–ª—é–¥–∞</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- –ê–ë–û–ù–ï–ú–ï–ù–¢ --></ claude>
                <div x-show="tab == 'st_subscription'">
                    <h2 class="text-2xl font-black mb-6 uppercase">üé´ –ú–æ–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç</h2>

                    <!-- –í–´–ë–û–† –¢–ò–ü–ê –ê–ë–û–ù–ï–ú–ï–ù–¢–ê -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div @click="if(hasActiveSubscription('–ó–∞–≤—Ç—Ä–∞–∫–∏')) selectedSubType = '–ó–∞–≤—Ç—Ä–∞–∫–∏'"
                             :class="[hasActiveSubscription('–ó–∞–≤—Ç—Ä–∞–∫–∏') ? 'cursor-pointer hover:scale-105' : 'opacity-40 cursor-not-allowed', selectedSubType == '–ó–∞–≤—Ç—Ä–∞–∫–∏' ? 'ring-4 ring-orange-400' : '']"
                             class="bg-gradient-to-br from-orange-500 to-orange-600 p-8 rounded-3xl text-white shadow-xl transition-all">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-2xl font-black">üåÖ –ó–ê–í–¢–†–ê–ö–ò</h3>
                                <span x-show="hasActiveSubscription('–ó–∞–≤—Ç—Ä–∞–∫–∏')" class="bg-white text-orange-600 px-3 py-1 rounded-full text-xs font-black uppercase">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                <span x-show="!hasActiveSubscription('–ó–∞–≤—Ç—Ä–∞–∫–∏')" class="bg-orange-700 text-white px-3 py-1 rounded-full text-xs font-black uppercase">–ù–µ –∫—É–ø–ª–µ–Ω</span>
                            </div>
                            <p class="text-sm opacity-90 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ 1 –±–ª—é–¥–æ + 1 –Ω–∞–ø–∏—Ç–æ–∫</p>
                            <div x-show="usedSubscriptionToday('–ó–∞–≤—Ç—Ä–∞–∫–∏')" class="bg-orange-700 rounded-xl p-3 text-sm font-bold">
                                ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è
                            </div>
                        </div>

                        <div @click="if(hasActiveSubscription('–û–±–µ–¥—ã')) selectedSubType = '–û–±–µ–¥—ã'"
                             :class="[hasActiveSubscription('–û–±–µ–¥—ã') ? 'cursor-pointer hover:scale-105' : 'opacity-40 cursor-not-allowed', selectedSubType == '–û–±–µ–¥—ã' ? 'ring-4 ring-emerald-400' : '']"
                             class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-8 rounded-3xl text-white shadow-xl transition-all">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-2xl font-black">üçΩÔ∏è –û–ë–ï–î–´</h3>
                                <span x-show="hasActiveSubscription('–û–±–µ–¥—ã')" class="bg-white text-emerald-600 px-3 py-1 rounded-full text-xs font-black uppercase">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                <span x-show="!hasActiveSubscription('–û–±–µ–¥—ã')" class="bg-emerald-700 text-white px-3 py-1 rounded-full text-xs font-black uppercase">–ù–µ –∫—É–ø–ª–µ–Ω</span>
                            </div>
                            <p class="text-sm opacity-90 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ 1 –ø–µ—Ä–≤–æ–µ + 1 –≤—Ç–æ—Ä–æ–µ + 1 –Ω–∞–ø–∏—Ç–æ–∫</p>
                            <div x-show="usedSubscriptionToday('–û–±–µ–¥—ã')" class="bg-emerald-700 rounded-xl p-3 text-sm font-bold">
                                ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è
                            </div>
                        </div>
                    </div>

                    <!-- –í–´–ë–û–† –ë–õ–Æ–î -->
                    <template x-if="selectedSubType && hasActiveSubscription(selectedSubType) && !usedSubscriptionToday(selectedSubType)">
                        <div>
                            <h3 class="text-xl font-black mb-4 uppercase" :class="selectedSubType == '–ó–∞–≤—Ç—Ä–∞–∫–∏' ? 'text-orange-600' : 'text-emerald-600'" x-text="'–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞ –¥–ª—è ' + selectedSubType"></h3>

                            <!-- –ò–ù–°–¢–†–£–ö–¶–ò–Ø -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-4 mb-6">
                                <template x-if="selectedSubType == '–ó–∞–≤—Ç—Ä–∞–∫–∏'">
                                    <p class="text-sm font-bold text-blue-700">üìã –í—ã–±–µ—Ä–∏—Ç–µ: <b>1 –±–ª—é–¥–æ</b> (–ø–µ—Ä–≤–æ–µ –ò–õ–ò –≤—Ç–æ—Ä–æ–µ) + <b>1 –Ω–∞–ø–∏—Ç–æ–∫</b></p>
                                </template>
                                <template x-if="selectedSubType == '–û–±–µ–¥—ã'">
                                    <p class="text-sm font-bold text-blue-700">üìã –í—ã–±–µ—Ä–∏—Ç–µ: <b>1 –ø–µ—Ä–≤–æ–µ –±–ª—é–¥–æ</b> + <b>1 –≤—Ç–æ—Ä–æ–µ –±–ª—é–¥–æ</b> + <b>1 –Ω–∞–ø–∏—Ç–æ–∫</b></p>
                                </template>
                            </div>

                            <!-- –ü–µ—Ä–≤–æ–µ –±–ª—é–¥–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è –û–±–µ–¥–æ–≤) -->
                            <template x-if="selectedSubType == '–û–±–µ–¥—ã'">
                                <div class="mb-6">
                                    <h4 class="font-black text-sm text-slate-400 uppercase mb-3">ü•£ –ü–µ—Ä–≤–æ–µ –±–ª—é–¥–æ</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <template x-for="m in menu.filter(dish => (dish.category || '–û–±–µ–¥') == '–û–±–µ–¥' && dish.type == '–ü–µ—Ä–≤–æ–µ' && dish.portions > 0)">
                                            <div @click="toggleSubDish(m.id, '–ü–µ—Ä–≤–æ–µ')"
                                                 :class="selectedSubDishes.includes(m.id) ? 'ring-4 ring-emerald-500 bg-emerald-50' : 'bg-white hover:shadow-md'"
                                                 class="p-4 rounded-2xl border cursor-pointer transition-all">
                                                <h5 class="font-bold text-sm" x-text="m.name"></h5>
                                                <p class="text-xs text-slate-400 mt-1" x-text="'–ü–æ—Ä—Ü–∏–π: ' + m.portions"></p>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- –í—Ç–æ—Ä–æ–µ –±–ª—é–¥–æ -->
                            <div class="mb-6">
                                <h4 class="font-black text-sm text-slate-400 uppercase mb-3">üçó <span x-text="selectedSubType == '–ó–∞–≤—Ç—Ä–∞–∫–∏' ? '–ë–ª—é–¥–æ (–ø–µ—Ä–≤–æ–µ –∏–ª–∏ –≤—Ç–æ—Ä–æ–µ)' : '–í—Ç–æ—Ä–æ–µ –±–ª—é–¥–æ'"></span></h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <template x-for="m in menu.filter(dish => {
                                        const matchCategory = (dish.category || '–û–±–µ–¥') == (selectedSubType == '–ó–∞–≤—Ç—Ä–∞–∫–∏' ? '–ó–∞–≤—Ç—Ä–∞–∫' : '–û–±–µ–¥');
                                        const matchType = selectedSubType == '–ó–∞–≤—Ç—Ä–∞–∫–∏' ? (dish.type == '–ü–µ—Ä–≤–æ–µ' || dish.type == '–í—Ç–æ—Ä–æ–µ') : dish.type == '–í—Ç–æ—Ä–æ–µ';
                                        return matchCategory && matchType && dish.portions > 0;
                                    })">
                                        <div @click="toggleSubDish(m.id, '–í—Ç–æ—Ä–æ–µ')"
                                             :class="selectedSubDishes.includes(m.id) ? 'ring-4 ring-emerald-500 bg-emerald-50' : 'bg-white hover:shadow-md'"
                                             class="p-4 rounded-2xl border cursor-pointer transition-all">
                                            <h5 class="font-bold text-sm" x-text="m.name"></h5>
                                            <p class="text-xs text-slate-400 mt-1"><span x-text="m.type"></span> ‚Ä¢ –ü–æ—Ä—Ü–∏–π: <span x-text="m.portions"></span></p>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- –ù–∞–ø–∏—Ç–æ–∫ -->
                            <div class="mb-6">
                                <h4 class="font-black text-sm text-slate-400 uppercase mb-3">ü•§ –ù–∞–ø–∏—Ç–æ–∫</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <template x-for="m in menu.filter(dish => {
                                        const matchCategory = (dish.category || '–û–±–µ–¥') == (selectedSubType == '–ó–∞–≤—Ç—Ä–∞–∫–∏' ? '–ó–∞–≤—Ç—Ä–∞–∫' : '–û–±–µ–¥');
                                        return matchCategory && dish.type == '–ù–∞–ø–∏—Ç–æ–∫' && dish.portions > 0;
                                    })">
                                        <div @click="toggleSubDish(m.id, '–ù–∞–ø–∏—Ç–æ–∫')"
                                             :class="selectedSubDishes.includes(m.id) ? 'ring-4 ring-blue-500 bg-blue-50' : 'bg-white hover:shadow-md'"
                                             class="p-4 rounded-2xl border cursor-pointer transition-all">
                                            <h5 class="font-bold text-sm" x-text="m.name"></h5>
                                            <p class="text-xs text-slate-400 mt-1" x-text="'–ü–æ—Ä—Ü–∏–π: ' + m.portions"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- –ö–ù–û–ü–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø -->
                            <button @click="useSubscription()"
                                    :disabled="!canUseSubscription() || useSubLoading"
                                    :class="[canUseSubscription() && !useSubLoading ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-300 cursor-not-allowed', useSubLoading ? 'btn-loading' : '']"
                                    class="w-full py-5 rounded-2xl text-white font-black uppercase text-lg shadow-xl transition-all relative">
                                <span class="btn-text">‚úÖ –ü–æ–ª—É—á–∏—Ç—å –±–ª—é–¥–∞ –ø–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—É</span>
                                <template x-if="useSubLoading">
                                    <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                </template>
                            </button>
                        </div>
                    </template>

                    <!-- –°–û–û–ë–©–ï–ù–ò–ï –ï–°–õ–ò –£–ñ–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–õ –°–ï–ì–û–î–ù–Ø -->
                    <template x-if="selectedSubType && usedSubscriptionToday(selectedSubType)">
                        <div class="text-center py-16 bg-slate-50 rounded-3xl border-2 border-dashed">
                            <i class="fas fa-check-circle text-6xl text-emerald-400 mb-4"></i>
                            <p class="font-black uppercase text-slate-600 text-xl">–ê–±–æ–Ω–µ–º–µ–Ω—Ç —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–µ–≥–æ–¥–Ω—è</p>
                            <p class="text-slate-400 mt-2">–ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞ –∑–∞ –Ω–æ–≤—ã–º –∫–æ–º–ø–ª–µ–∫—Ç–æ–º!</p>
                        </div>
                    </template>

                    <!-- –°–û–û–ë–©–ï–ù–ò–ï –ï–°–õ–ò –ù–ï–¢ –ê–ö–¢–ò–í–ù–û–ì–û –ê–ë–û–ù–ï–ú–ï–ù–¢–ê -->
                    <template x-if="!selectedSubType">
                        <div class="text-center py-16 bg-slate-50 rounded-3xl border-2 border-dashed">
                            <i class="fas fa-ticket-alt text-6xl text-slate-300 mb-4"></i>
                            <p class="font-black uppercase text-slate-400">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞</p>
                            <p class="text-slate-400 text-sm mt-2">–ö—É–ø–∏—Ç–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–ö–æ—à–µ–ª—ë–∫¬ª</p>
                        </div>
                    </template>
                </div>

                <!-- –ú–û–ò –ó–ê–ö–ê–ó–´ -->
                <div x-show="tab == 'st_history'">
                    <h2 class="text-2xl font-black mb-6 uppercase">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                    <div class="bg-white rounded-3xl border overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400"><tr><th class="p-5">–ë–ª—é–¥–æ</th><th class="p-5 text-center">–°—Ç–∞—Ç—É—Å</th><th class="p-5 text-right">–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
                            <tbody>
                                <template x-for="o in orders.filter(x => x.user == user.username).slice().reverse()">
                                    <tr class="border-t relative">
                                        <td class="p-5 font-bold" x-text="o.name"></td>
                                        <td class="p-5 text-center"><span :class="o.status == '–í—ã–¥–∞–Ω–æ' ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-100 text-orange-600'" class="px-3 py-1 rounded-full text-[10px] font-black uppercase" x-text="o.status"></span></td>
                                        <td class="p-5 text-right">
                                            <template x-if="o.status == '–û–ø–ª–∞—á–µ–Ω–æ'">
                                                <!-- –û–í–ï–†–õ–ï–ô "–û—Ç–º–µ—á–µ–Ω–æ!" –Ω–∞ —Å—Ç—Ä–æ–∫–µ -->
                                                <div x-show="eatenRows[o.id]" class="eaten-overlay" :class="eatenRowsExit[o.id] ? 'fade-out' : ''">
                                                    <i class="fas fa-utensils"></i>
                                                    <span>–û—Ç–º–µ—á–µ–Ω–æ!</span>
                                                </div>
                                                <button @click="confirmOrderStudent(o.id)"
                                                        :disabled="confirmingOrder == o.id"
                                                        :class="confirmingOrder == o.id ? 'btn-loading' : ''"
                                                        class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] uppercase font-bold hover:bg-emerald-600 relative">
                                                    <span class="btn-text">–Ø –ø–æ–µ–ª(–∞)</span>
                                                    <template x-if="confirmingOrder == o.id">
                                                        <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                                    </template>
                                                </button>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                                <template x-if="orders.filter(x => x.user == user.username).length === 0">
                                    <tr><td colspan="3" class="p-10 text-center text-slate-400 font-bold">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</td></tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –ö–û–®–ï–õ–ï–ö -->
                <div x-show="tab == 'st_wallet'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-10 rounded-[2rem] border text-center shadow-lg">
                            <p class="text-xs font-black text-slate-400 uppercase mb-2">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
                            <h1 class="text-6xl font-black text-slate-800 mb-8" x-text="user.balance + ' ‚ÇΩ'"></h1>

                            <!-- –ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –ö–ê–†–¢–´ -->
                            <template x-if="!hasCard">
                                <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-6 mb-4">
                                    <i class="fas fa-credit-card text-red-500 text-4xl mb-3"></i>
                                    <p class="font-bold text-red-700 text-sm">–ö–∞—Ä—Ç–∞ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞</p>
                                    <p class="text-red-600 text-xs mt-2">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "–ú–æ—è –∫–∞—Ä—Ç–∞" –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏</p>
                                </div>
                            </template>

                            <template x-if="hasCard">
                                <div class="bg-emerald-50 border-2 border-emerald-200 rounded-2xl p-4 mb-4">
                                    <i class="fas fa-check-circle text-emerald-500 text-2xl mb-2"></i>
                                    <p class="font-bold text-emerald-700 text-sm">–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞</p>
                                    <p class="text-emerald-600 text-xs mt-1" x-text="'**** **** **** ' + (user.cardNumber ? user.cardNumber.slice(-4) : '')"></p>
                                </div>
                            </template>

                            <input type="number" x-model="refillAmount" class="w-full p-4 border rounded-2xl mb-4 text-center font-bold bg-slate-50 outline-none focus:border-emerald-500" :disabled="!hasCard">
                            <button @click="refill()"
                                    :disabled="!hasCard || refillLoading"
                                    :class="[hasCard ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-slate-300 cursor-not-allowed', refillLoading ? 'btn-loading' : '']"
                                    class="w-full text-white py-4 rounded-2xl font-bold uppercase shadow-lg transition-all relative">
                                <span class="btn-text" x-text="hasCard ? '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å' : '–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∫–∞—Ä—Ç—É'"></span>
                                <template x-if="refillLoading">
                                    <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                </template>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div @click="buySub('–ó–∞–≤—Ç—Ä–∞–∫–∏', 3300)"
                                 class="bg-blue-600 p-8 rounded-[2rem] text-white cursor-pointer shadow-xl hover:scale-[1.02] transition-transform relative overflow-hidden">
                                <template x-if="subLoading == '–ó–∞–≤—Ç—Ä–∞–∫–∏'">
                                    <div class="absolute inset-0 bg-blue-800/60 z-10 flex items-center justify-center">
                                        <div class="btn-spinner-ring"></div>
                                    </div>
                                </template>
                                <h4 class="font-bold uppercase text-xs opacity-80">–ê–±–æ–Ω–µ–º–µ–Ω—Ç –ó–∞–≤—Ç—Ä–∞–∫–∏</h4><div class="text-3xl font-black">3 300 ‚ÇΩ</div>
                            </div>
                            <div @click="buySub('–û–±–µ–¥—ã', 5500)"
                                 class="bg-orange-500 p-8 rounded-[2rem] text-white cursor-pointer shadow-xl hover:scale-[1.02] transition-transform relative overflow-hidden">
                                <template x-if="subLoading == '–û–±–µ–¥—ã'">
                                    <div class="absolute inset-0 bg-orange-800/60 z-10 flex items-center justify-center">
                                        <div class="btn-spinner-ring"></div>
                                    </div>
                                </template>
                                <h4 class="font-bold uppercase text-xs opacity-80">–ê–±–æ–Ω–µ–º–µ–Ω—Ç –û–±–µ–¥—ã</h4><div class="text-3xl font-black">5 500 ‚ÇΩ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ú–û–Ø –ö–ê–†–¢–ê -->
                <div x-show="tab == 'st_card'">
                    <h2 class="text-2xl font-black mb-6 uppercase flex items-center gap-2">
                        <i class="fas fa-credit-card text-blue-600"></i> –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞
                    </h2>

                    <!-- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ -->
                    <div class="mb-8">
                        <div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-900 p-8 rounded-3xl shadow-2xl max-w-md mx-auto text-white relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-40 h-40 bg-white opacity-10 rounded-full -mr-20 -mt-20"></div>
                            <div class="absolute bottom-0 left-0 w-32 h-32 bg-white opacity-10 rounded-full -ml-16 -mb-16"></div>

                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-8">
                                    <i class="fas fa-credit-card text-3xl opacity-80"></i>
                                    <span class="text-xs font-bold opacity-60 uppercase">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span>
                                </div>

                                <div class="mb-6">
                                    <p class="text-xs opacity-60 uppercase mb-1">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</p>
                                    <p class="text-2xl font-mono tracking-wider" x-text="cardNumber || '**** **** **** ****'"></p>
                                </div>

                                <div class="flex justify-between items-end">
                                    <div>
                                        <p class="text-[10px] opacity-60 uppercase mb-1">–î–µ—Ä–∂–∞—Ç–µ–ª—å</p>
                                        <p class="text-sm font-bold uppercase" x-text="cardHolder || 'IVAN IVANOV'"></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[10px] opacity-60 uppercase mb-1">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</p>
                                        <p class="text-sm font-bold font-mono" x-text="cardExpiry || 'MM/YY'"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –§–û–†–ú–ê –í–í–û–î–ê –î–ê–ù–ù–´–• –ö–ê–†–¢–´ -->
                    <div class="bg-white p-8 rounded-[2rem] border shadow-sm max-w-2xl mx-auto">
                        <template x-if="hasCard">
                            <div class="bg-emerald-50 border-2 border-emerald-500 rounded-2xl p-4 mb-6 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-check-circle text-emerald-600 text-2xl"></i>
                                    <div>
                                        <p class="font-black text-emerald-700 uppercase text-sm">–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞</p>
                                        <p class="text-emerald-600 text-xs">–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–æ–ª–Ω—è—Ç—å –±–∞–ª–∞–Ω—Å</p>
                                    </div>
                                </div>
                                <button @click="removeCard()"
                                        :disabled="removeCardLoading"
                                        :class="removeCardLoading ? 'btn-loading' : ''"
                                        class="bg-red-500 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-red-600 transition-all relative">
                                    <span class="btn-text">–£–¥–∞–ª–∏—Ç—å</span>
                                    <template x-if="removeCardLoading">
                                        <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                    </template>
                                </button>
                            </div>
                        </template>

                        <template x-if="!hasCard">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-4 mb-6">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                <span class="text-blue-700 font-bold text-sm">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞</span>
                            </div>
                        </template>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-black text-slate-400 uppercase mb-2">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                                <input
                                    type="text"
                                    x-model="cardNumber"
                                    @input="cardNumber = formatCardNumber(cardNumber.replace(/\s/g, '').slice(0, 16))"
                                    placeholder="1234 5678 9012 3456"
                                    maxlength="19"
                                    class="w-full p-4 border-2 rounded-2xl font-mono text-lg font-bold bg-slate-50 outline-none focus:border-blue-500 transition-all">
                            </div>

                            <div>
                                <label class="block text-xs font-black text-slate-400 uppercase mb-2">–î–µ—Ä–∂–∞—Ç–µ–ª—å –∫–∞—Ä—Ç—ã</label>
                                <input
                                    type="text"
                                    x-model="cardHolder"
                                    placeholder="IVAN IVANOV"
                                    class="w-full p-4 border-2 rounded-2xl font-bold uppercase bg-slate-50 outline-none focus:border-blue-500 transition-all">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-black text-slate-400 uppercase mb-2">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                                    <input
                                        type="text"
                                        x-model="cardExpiry"
                                        @input="if(cardExpiry.length === 2 && !cardExpiry.includes('/')) cardExpiry += '/'"
                                        placeholder="MM/YY"
                                        maxlength="5"
                                        class="w-full p-4 border-2 rounded-2xl font-mono font-bold bg-slate-50 outline-none focus:border-blue-500 transition-all">
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-400 uppercase mb-2">CVV</label>
                                    <input
                                        type="password"
                                        x-model="cardCVV"
                                        placeholder="123"
                                        maxlength="3"
                                        class="w-full p-4 border-2 rounded-2xl font-mono font-bold bg-slate-50 outline-none focus:border-blue-500 transition-all">
                                </div>
                            </div>
                        </div>

                        <button @click="saveCard()"
                                :disabled="saveCardLoading"
                                :class="saveCardLoading ? 'btn-loading' : ''"
                                class="w-full mt-6 bg-blue-600 text-white py-4 rounded-2xl font-black uppercase shadow-lg hover:bg-blue-700 transition-all relative">
                            <span class="btn-text"><i class="fas fa-save mr-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</span>
                            <template x-if="saveCardLoading">
                                <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                            </template>
                        </button>

                        <div class="mt-6 bg-slate-50 rounded-2xl p-4">
                            <p class="text-xs text-slate-500 flex items-start gap-2">
                                <i class="fas fa-lock text-slate-400 mt-0.5"></i>
                                <span>–î–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π –∫–∞—Ä—Ç—ã –Ω–∞–¥—ë–∂–Ω–æ –∑–∞—â–∏—â–µ–Ω—ã. CVV-–∫–æ–¥ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫–∞—Ä—Ç—ã.</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- –ê–õ–õ–ï–†–ì–ò–ò -->
                <div x-show="tab == 'st_profile'">
                    <h2 class="text-2xl font-black mb-6 uppercase text-red-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è</h2>
                    <div class="bg-white p-8 rounded-[2rem] border shadow-sm">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                            <template x-for="alg in ['–õ–∞–∫—Ç–æ–∑–∞', '–û—Ä–µ—Ö–∏', '–ì–ª—é—Ç–µ–Ω', '–Ø–π—Ü–∞', '–¶–∏—Ç—Ä—É—Å', '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã']">
                                <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-2xl cursor-pointer border-2 border-transparent hover:border-red-100 transition-all">
                                    <input type="checkbox" :value="alg" x-model="selectedAllergens" class="w-5 h-5 rounded accent-red-500">
                                    <span class="font-bold text-sm text-slate-700" x-text="alg"></span>
                                </label>
                            </template>
                        </div>
                        <textarea x-model="allergiesText" class="w-full p-6 border rounded-[2rem] h-32 outline-none mb-4 focus:border-red-500 bg-slate-50 font-bold" placeholder="–î—Ä—É–≥–∏–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)..."></textarea>
                        <button @click="saveProfile()"
                                :disabled="profileLoading"
                                :class="profileLoading ? 'btn-loading' : ''"
                                class="w-full bg-red-500 text-white py-4 rounded-2xl font-black uppercase shadow-lg hover:bg-red-600 transition-all relative">
                            <span class="btn-text">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                            <template x-if="profileLoading">
                                <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                            </template>
                        </button>
                    </div>
                </div>

                <!-- –í–ö–õ–ê–î–ö–ò –ü–û–í–ê–†–ê: –û–ß–ï–†–ï–î–¨ –í–´–î–ê–ß–ò -->
                <div x-show="tab == 'ch_issue'">
                    <h2 class="text-2xl font-black mb-6 uppercase">–û—á–µ—Ä–µ–¥—å –≤—ã–¥–∞—á–∏</h2>
                    <div class="space-y-3">
                        <template x-for="o in orders.filter(x => x.status == '–û–ø–ª–∞—á–µ–Ω–æ')">
                            <div class="bg-white p-5 rounded-2xl border flex justify-between items-center shadow-sm hover:shadow-md transition-all relative overflow-hidden">
                                <!-- –û–í–ï–†–õ–ï–ô "–í—ã–¥–∞–Ω–æ!" -->
                                <div x-show="issuedRows[o.id]" class="eaten-overlay" :class="issuedRowsExit[o.id] ? 'fade-out' : ''">
                                    <i class="fas fa-check-circle"></i>
                                    <span>–í—ã–¥–∞–Ω–æ!</span>
                                </div>
                                <div>
                                    <b class="text-lg" x-text="o.name"></b>
                                    <p class="text-sm text-slate-400" x-text="'–£—á–µ–Ω–∏–∫: ' + o.user"></p>
                                </div>
                                <button @click="confirmOrderChef(o.id)"
                                        :disabled="confirmingOrder == o.id"
                                        :class="confirmingOrder == o.id ? 'btn-loading' : ''"
                                        class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold uppercase text-xs hover:bg-blue-700 transition-all relative">
                                    <span class="btn-text">–í—ã–¥–∞—Ç—å</span>
                                    <template x-if="confirmingOrder == o.id">
                                        <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                    </template>
                                </button>
                            </div>
                        </template>
                        <template x-if="orders.filter(x => x.status == '–û–ø–ª–∞—á–µ–Ω–æ').length === 0">
                            <div class="text-center py-10">
                                <i class="fas fa-check-circle text-4xl text-emerald-400 mb-4"></i>
                                <p class="font-bold text-slate-400">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- –°–ö–õ–ê–î –ò –ö–£–•–ù–Ø -->
                <div x-show="tab == 'ch_stock'">
                    <h2 class="text-2xl font-black mb-6 uppercase text-blue-600">–°–∫–ª–∞–¥ –∏ –ö—É—Ö–Ω—è</h2>
                    <div class="bg-white p-6 rounded-3xl border shadow-sm mb-8 border-l-8 border-emerald-500">
                        <h3 class="font-black text-sm text-slate-400 uppercase mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –±–ª—é–¥–æ</h3>
                        <p class="text-sm text-slate-600 mb-4"><i class="fas fa-info-circle text-blue-500 mr-2"></i>–ë–ª—é–¥–æ —Å—Ä–∞–∑—É –ø–æ—è–≤–∏—Ç—Å—è —É —É—á–µ–Ω–∏–∫–æ–≤ –≤ –º–µ–Ω—é</p>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
                            <input type="text" x-model="newDish.name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞" class="p-3 bg-slate-50 border rounded-xl font-bold outline-none focus:border-emerald-500">
                            <input type="number" x-model="newDish.price" placeholder="–¶–µ–Ω–∞ (—Ä—É–±)" class="p-3 bg-slate-50 border rounded-xl font-bold outline-none focus:border-emerald-500">
                            <input type="number" x-model="newDish.portions" placeholder="–ö–æ–ª-–≤–æ –ø–æ—Ä—Ü–∏–π" class="p-3 bg-slate-50 border rounded-xl font-bold outline-none focus:border-emerald-500">
                            <select x-model="newDish.category" class="p-3 bg-slate-50 border rounded-xl font-bold outline-none focus:border-emerald-500">
                                <option value="–ó–∞–≤—Ç—Ä–∞–∫">üåÖ –ó–∞–≤—Ç—Ä–∞–∫</option><option value="–û–±–µ–¥" selected>üçΩÔ∏è –û–±–µ–¥</option>
                            </select>
                            <select x-model="newDish.type" class="p-3 bg-slate-50 border rounded-xl font-bold outline-none focus:border-emerald-500">
                                <option value="–ü–µ—Ä–≤–æ–µ">–ü–µ—Ä–≤–æ–µ</option><option value="–í—Ç–æ—Ä–æ–µ" selected>–í—Ç–æ—Ä–æ–µ</option><option value="–°–∞–ª–∞—Ç">–°–∞–ª–∞—Ç</option><option value="–í—ã–ø–µ—á–∫–∞">–í—ã–ø–µ—á–∫–∞</option><option value="–ù–∞–ø–∏—Ç–æ–∫">–ù–∞–ø–∏—Ç–æ–∫</option><option value="–ó–∞–∫—É—Å–∫–∞">–ó–∞–∫—É—Å–∫–∞</option>
                            </select>
                        </div>
                        <!-- –ü–û–õ–ï –î–õ–Ø –°–û–°–¢–ê–í–ê -->
                        <textarea x-model="newDish.ingredients" placeholder="–°–æ—Å—Ç–∞–≤ –±–ª—é–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫—É—Ä–∏—Ü–∞, —Ä–∏—Å, –º–æ—Ä–∫–æ–≤—å, –ª—É–∫, —Å–ø–µ—Ü–∏–∏)" class="w-full p-3 bg-slate-50 border rounded-xl font-bold outline-none focus:border-emerald-500 mb-3 h-20 resize-none"></textarea>
                        <button @click="addNewDish()"
                                :disabled="addDishLoading"
                                :class="addDishLoading ? 'btn-loading' : ''"
                                class="w-full mt-1 bg-emerald-500 text-white py-3 rounded-xl font-black uppercase hover:bg-emerald-600 transition-all shadow-lg relative">
                            <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å –≤ –º–µ–Ω—é –¥–ª—è –≤—Å–µ—Ö</span>
                            <template x-if="addDishLoading">
                                <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                            </template>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-black text-sm text-slate-400 uppercase">–ë–ª—é–¥–∞ –≤ –º–µ–Ω—é</h3>
                                <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-[10px] font-black uppercase" x-text="'–í—Å–µ–≥–æ: ' + menu.length"></span>
                            </div>
                            <div class="space-y-3 max-h-[500px] overflow-y-auto scroll-custom p-1">
                                <template x-for="(m, index) in menu">
                                    <div class="bg-white p-5 rounded-2xl border flex justify-between items-center hover:shadow-md transition-all" :class="index % 2 === 0 ? 'border-l-4 border-blue-500' : 'border-l-4 border-emerald-500'">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <b class="text-lg" x-text="m.name"></b>
                                                <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-black uppercase" x-text="m.type"></span>
                                            </div>
                                            <p class="text-sm text-slate-400"><span class="font-bold" x-text="m.price + ' ‚ÇΩ'"></span> ‚Ä¢ <span x-text="m.portions + ' –ø–æ—Ä—Ü–∏–π'"></span></p>
                                            <p class="text-xs text-slate-500 mt-1"><i class="fas fa-list-ul mr-1"></i><span x-text="m.ingredients || '–°–æ—Å—Ç–∞–≤ –Ω–µ —É–∫–∞–∑–∞–Ω'"></span></p>
                                            <p class="text-xs text-slate-400 mt-1" x-text="'–î–æ–±–∞–≤–ª–µ–Ω–æ: ' + formatDate(m.addedDate)"></p>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <button @click="updateStock(m, -1)" class="w-8 h-8 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors flex items-center justify-center">
                                                <i class="fas fa-minus text-xs"></i>
                                            </button>
                                            <span class="w-8 text-center font-black text-lg" :class="m.portions < 3 ? 'text-orange-600' : 'text-slate-800'" x-text="m.portions"></span>
                                            <button @click="updateStock(m, 1)" class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center">
                                                <i class="fas fa-plus text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="menu.length === 0">
                                    <div class="text-center py-10 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                                        <i class="fas fa-utensils text-4xl text-slate-300 mb-4"></i>
                                        <p class="font-bold text-slate-400">–ù–µ—Ç –±–ª—é–¥ –≤ –º–µ–Ω—é</p>
                                        <p class="text-slate-400 text-sm mt-2">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –±–ª—é–¥–æ</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-black text-sm text-slate-400 uppercase mb-4">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–∞ —Å–∫–ª–∞–¥–µ</h3>
                            <div class="bg-white rounded-3xl border p-5 space-y-4 shadow-sm">
                                <template x-for="i in ingredients">
                                    <div class="flex justify-between items-center border-b pb-3 last:border-0 hover:bg-slate-50 p-2 rounded-xl transition-colors">
                                        <div>
                                            <b x-text="i.name"></b>
                                            <p class="text-xs text-slate-400" x-text="'–ï–¥.–∏–∑–º: ' + i.unit"></p>
                                        </div>
                                        <input type="number" x-model.number="i.amount" @change="setIng(i)" class="w-24 p-2 bg-slate-50 border rounded-xl text-center font-bold focus:border-blue-500 outline-none">
                                    </div>
                                </template>
                                <div class="pt-4 flex gap-2">
                                    <input type="text" x-model="newIng.name" placeholder="–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç" class="flex-1 p-3 bg-slate-50 border rounded-xl text-sm font-bold outline-none focus:border-blue-500">
                                    <input type="text" x-model="newIng.unit" placeholder="–∫–≥" class="w-20 p-3 bg-slate-50 border rounded-xl text-sm font-bold text-center outline-none">
                                    <button @click="addNewIngredient()"
                                            :disabled="addIngLoading"
                                            :class="addIngLoading ? 'btn-loading' : ''"
                                            class="bg-blue-600 text-white px-4 rounded-xl text-sm font-bold hover:bg-blue-700 transition-colors relative">
                                        <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å</span>
                                        <template x-if="addIngLoading">
                                            <div class="btn-spinner"><div class="btn-spinner-ring" style="width:16px;height:16px;border-width:2px"></div></div>
                                        </template>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –£–ß–ï–¢ –í–´–î–ê–ß–ò -->
                <div x-show="tab == 'ch_accounting'">
                    <h2 class="text-2xl font-black mb-6 uppercase">–£—á–µ—Ç –≤—ã–¥–∞—á–∏</h2>
                    <div class="bg-white rounded-3xl border overflow-hidden shadow-sm">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 font-black uppercase text-slate-400 text-[10px]"><tr><th class="p-5">–í—Ä–µ–º—è</th><th class="p-5">–£—á–µ–Ω–∏–∫</th><th class="p-5">–ë–ª—é–¥–æ</th></tr></thead>
                            <tbody><template x-for="o in orders.filter(x => x.status == '–í—ã–¥–∞–Ω–æ').slice().reverse()"><tr class="border-t"><td class="p-5 text-slate-400" x-text="o.issuedAt || '–†–∞–Ω–µ–µ'"></td><td class="p-5 font-bold" x-text="o.user"></td><td class="p-5" x-text="o.name"></td></tr></template></tbody>
                        </table>
                    </div>
                </div>

                <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê –ê–î–ú–ò–ù -->
                <div x-show="tab == 'ad_stats'">
                    <h2 class="text-2xl font-black mb-6 uppercase">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

                    <!-- –û–°–ù–û–í–ù–´–ï –§–ò–ù–ê–ù–°–û–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-6 rounded-3xl border border-b-4 border-emerald-500">
                            <p class="text-slate-400 font-bold uppercase text-[10px] mb-1">üí∞ –ü–æ–ª—É—á–µ–Ω–æ (–≤—Å–µ–≥–æ)</p>
                            <h1 class="text-3xl font-black text-emerald-600" x-text="(stat_dishRevenue + stat_subRevenue) + ' ‚ÇΩ'"></h1>
                            <p class="text-xs text-slate-400 mt-1">–ë–ª—é–¥–∞ + –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-b-4 border-red-500">
                            <p class="text-slate-400 font-bold uppercase text-[10px] mb-1">üí∏ –ó–∞—Ç—Ä–∞—á–µ–Ω–æ</p>
                            <h1 class="text-3xl font-black text-red-600" x-text="stat_purchaseExpense + ' ‚ÇΩ'"></h1>
                            <p class="text-xs text-slate-400 mt-1">–ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-b-4 border-blue-500">
                            <p class="text-slate-400 font-bold uppercase text-[10px] mb-1">üìä –ü—Ä–∏–±—ã–ª—å</p>
                            <h1 class="text-3xl font-black text-blue-600" x-text="((stat_dishRevenue + stat_subRevenue) - stat_purchaseExpense) + ' ‚ÇΩ'"></h1>
                            <p class="text-xs text-slate-400 mt-1">–î–æ—Ö–æ–¥ - –†–∞—Å—Ö–æ–¥</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-b-4 border-purple-500">
                            <p class="text-slate-400 font-bold uppercase text-[10px] mb-1">üë• –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</p>
                            <h1 class="text-3xl font-black text-purple-600" x-text="stat_attendance + '%'"></h1>
                            <p class="text-xs text-slate-400 mt-1">–í—ã–¥–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤</p>
                        </div>
                    </div>

                    <!-- –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –î–û–•–û–î–û–í -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">–í—ã—Ä—É—á–∫–∞ –æ—Ç –±–ª—é–¥</p>
                            <h1 class="text-4xl font-black" x-text="stat_dishRevenue + ' ‚ÇΩ'"></h1>
                            <p class="text-xs opacity-80 mt-2" x-text="stat_totalDishes + ' –±–ª—é–¥ –ø—Ä–æ–¥–∞–Ω–æ'"></p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</p>
                            <h1 class="text-4xl font-black" x-text="stat_subRevenue + ' ‚ÇΩ'"></h1>
                            <p class="text-xs opacity-80 mt-2" x-text="subTransactions.length + ' –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤'"></p>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">–í—Å–µ–≥–æ –±–ª—é–¥ –∫—É–ø–ª–µ–Ω–æ</p>
                            <h1 class="text-4xl font-black" x-text="stat_totalDishes"></h1>
                            <p class="text-xs opacity-80 mt-2">–í–∫–ª—é—á–∞—è –≤—ã–¥–∞–Ω–Ω—ã–µ</p>
                        </div>
                    </div>

                    <!-- –û–¢–ó–´–í–´ -->
                    <div class="bg-white p-8 rounded-[2rem] border shadow-sm">
                        <h3 class="font-black mb-6 uppercase text-lg flex items-center gap-2">
                            <i class="fas fa-comments text-blue-500"></i> –û—Ç–∑—ã–≤—ã
                        </h3>
                        <div class="space-y-4 max-h-[400px] overflow-y-auto scroll-custom">
                            <template x-for="r in reviews.slice().reverse()">
                                <div class="p-5 bg-slate-50 rounded-2xl border-l-4 border-blue-500">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-black text-[10px] uppercase text-blue-600" x-text="r.dish"></span>
                                        <span class="text-[9px] font-bold text-slate-400" x-text="r.author"></span>
                                    </div>
                                    <p class="text-sm italic text-slate-600" x-text="'¬´' + r.text + '¬ª'"></p>
                                </div>
                            </template>
                            <template x-if="reviews.length === 0">
                                <div class="text-center py-10 text-slate-400 font-bold">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- –§–ò–ù–ê–ù–°–û–í–´–ô –û–¢–ß–ï–¢ -->
                <div x-show="tab == 'ad_report'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black uppercase">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç</h2>
                        <button @click="downloadCSVReport()"
                                :disabled="csvLoading"
                                :class="csvLoading ? 'btn-loading' : ''"
                                class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black uppercase text-xs shadow-lg flex items-center gap-2 hover:bg-blue-700 relative">
                            <span class="btn-text"><i class="fas fa-file-download text-lg"></i> –°–∫–∞—á–∞—Ç—å CSV</span>
                            <template x-if="csvLoading">
                                <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                            </template>
                        </button>
                    </div>

                    <!-- –§–ò–ù–ê–ù–°–û–í–ê–Ø –°–í–û–î–ö–ê -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">üí∞ –ü–æ–ª—É—á–µ–Ω–æ</p>
                            <h1 class="text-3xl font-black" x-text="(stat_dishRevenue + stat_subRevenue) + ' ‚ÇΩ'"></h1>
                            <p class="text-xs opacity-80 mt-1">–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">üí∏ –ó–∞—Ç—Ä–∞—á–µ–Ω–æ</p>
                            <h1 class="text-3xl font-black" x-text="stat_purchaseExpense + ' ‚ÇΩ'"></h1>
                            <p class="text-xs opacity-80 mt-1">–ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">üìä –ü—Ä–∏–±—ã–ª—å</p>
                            <h1 class="text-3xl font-black" x-text="((stat_dishRevenue + stat_subRevenue) - stat_purchaseExpense) + ' ‚ÇΩ'"></h1>
                            <p class="text-xs opacity-80 mt-1">–ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">üçΩÔ∏è –ë–ª—é–¥ –ø—Ä–æ–¥–∞–Ω–æ</p>
                            <h1 class="text-3xl font-black" x-text="stat_totalDishes"></h1>
                            <p class="text-xs opacity-80 mt-1">–í—ã–¥–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-3xl text-white shadow-xl">
                            <p class="font-bold uppercase text-xs opacity-80 mb-1">üë• –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</p>
                            <h1 class="text-3xl font-black" x-text="stat_attendance + '%'"></h1>
                            <p class="text-xs opacity-80 mt-1">–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–¥–∞—á–∏</p>
                        </div>
                    </div>

                    <!-- –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –î–û–•–û–î–û–í –ò –†–ê–°–•–û–î–û–í -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white p-6 rounded-3xl border shadow-sm">
                            <h3 class="font-black uppercase text-sm text-emerald-600 mb-4 flex items-center gap-2">
                                <i class="fas fa-arrow-up"></i> –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl">
                                    <span class="font-bold text-sm">–ü—Ä–æ–¥–∞–∂–∞ –±–ª—é–¥</span>
                                    <span class="font-black text-lg text-blue-600" x-text="stat_dishRevenue + ' ‚ÇΩ'"></span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-xl">
                                    <span class="font-bold text-sm">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</span>
                                    <span class="font-black text-lg text-orange-600" x-text="stat_subRevenue + ' ‚ÇΩ'"></span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-xl border-2 border-emerald-500">
                                    <span class="font-black text-sm uppercase">–ò—Ç–æ–≥–æ –¥–æ—Ö–æ–¥</span>
                                    <span class="font-black text-xl text-emerald-600" x-text="(stat_dishRevenue + stat_subRevenue) + ' ‚ÇΩ'"></span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-3xl border shadow-sm">
                            <h3 class="font-black uppercase text-sm text-red-600 mb-4 flex items-center gap-2">
                                <i class="fas fa-arrow-down"></i> –†–∞—Å—Ö–æ–¥—ã
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-red-50 rounded-xl">
                                    <span class="font-bold text-sm">–ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
                                    <span class="font-black text-lg text-red-600" x-text="stat_purchaseExpense + ' ‚ÇΩ'"></span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                    <span class="font-bold text-sm text-slate-400">–û–¥–æ–±—Ä–µ–Ω–æ –∑–∞—è–≤–æ–∫</span>
                                    <span class="font-bold text-lg text-slate-600" x-text="purchases.filter(p => p.status === '–û–¥–æ–±—Ä–µ–Ω–æ').length + ' —à—Ç'"></span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl border-2 border-blue-500">
                                    <span class="font-black text-sm uppercase">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</span>
                                    <span class="font-black text-xl" :class="((stat_dishRevenue + stat_subRevenue) - stat_purchaseExpense) >= 0 ? 'text-blue-600' : 'text-red-600'" x-text="((stat_dishRevenue + stat_subRevenue) - stat_purchaseExpense) + ' ‚ÇΩ'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –¢–ê–ë–õ–ò–¶–ê –ó–ê–ö–ê–ó–û–í -->
                    <div class="bg-white rounded-3xl border overflow-hidden shadow-sm">
                        <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                            <div class="text-sm font-bold text-slate-700">
                                –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span class="text-blue-600" x-text="orders.length"></span>
                            </div>
                            <div class="flex gap-2">
                                <button @click="filterStatus = 'all'" :class="filterStatus == 'all' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'" class="px-4 py-2 rounded-xl text-xs font-bold border">–í—Å–µ</button>
                                <button @click="filterStatus = '–í—ã–¥–∞–Ω–æ'" :class="filterStatus == '–í—ã–¥–∞–Ω–æ' ? 'bg-emerald-600 text-white' : 'bg-white text-slate-700'" class="px-4 py-2 rounded-xl text-xs font-bold border">–í—ã–¥–∞–Ω–æ</button>
                                <button @click="filterStatus = '–û–ø–ª–∞—á–µ–Ω–æ'" :class="filterStatus == '–û–ø–ª–∞—á–µ–Ω–æ' ? 'bg-orange-600 text-white' : 'bg-white text-slate-700'" class="px-4 py-2 rounded-xl text-xs font-bold border">–û–∂–∏–¥–∞–µ—Ç</button>
                            </div>
                        </div>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 font-black uppercase text-slate-400 text-[10px]">
                                <tr>
                                    <th class="p-5">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                                    <th class="p-5">–£—á–µ–Ω–∏–∫</th>
                                    <th class="p-5">–ë–ª—é–¥–æ</th>
                                    <th class="p-5">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                    <th class="p-5">–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="o in filteredOrders.slice().reverse()">
                                    <tr class="border-t hover:bg-slate-50 transition-colors">
                                        <td class="p-5 text-slate-500 font-medium" x-text="o.issuedAt || formatDate(o.createdAt)"></td>
                                        <td class="p-5">
                                            <div class="font-bold" x-text="o.user"></div>
                                            <div class="text-xs text-slate-400" x-text="getUserClass(o.user)"></div>
                                        </td>
                                        <td class="p-5">
                                            <div class="font-bold" x-text="o.name"></div>
                                            <div class="text-xs text-slate-400" x-text="getDishType(o.name)"></div>
                                        </td>
                                        <td class="p-5 font-black text-lg" x-text="o.price + ' ‚ÇΩ'"></td>
                                        <td class="p-5">
                                            <span :class="o.status == '–í—ã–¥–∞–Ω–æ' ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-100 text-orange-600'"
                                                  class="px-3 py-1 rounded-full text-[10px] font-black uppercase"
                                                  x-text="o.status">
                                            </span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div class="p-5 bg-slate-50 border-t flex justify-between items-center">
                            <div class="text-sm font-bold text-slate-700">
                                –°—É–º–º–∞: <span class="text-emerald-600 text-lg" x-text="filteredOrders.reduce((sum, o) => sum + o.price, 0) + ' ‚ÇΩ'"></span>
                            </div>
                            <div class="text-sm font-bold text-slate-700">
                                –ü–æ–∫–∞–∑–∞–Ω–æ: <span x-text="filteredOrders.length"></span> –∏–∑ <span x-text="orders.length"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –û–¢–ó–´–í–´ –£–ß–ï–ù–ò–ö -->
                <div x-show="tab == 'st_rev'">
                    <h2 class="text-2xl font-black mb-6 uppercase">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
                    <div class="bg-white p-8 rounded-[2rem] border shadow-sm">
                        <select x-model="reviewDish" class="w-full p-4 border rounded-2xl mb-4 bg-slate-50 outline-none">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–æ...</option>
                            <template x-for="m in menu">
                                <option :value="m.name" x-text="m.name"></option>
                            </template>
                        </select>
                        <textarea x-model="reviewText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ..." class="w-full p-4 border rounded-2xl mb-4 h-32 outline-none focus:border-blue-500"></textarea>
                        <button @click="addReview()"
                                :disabled="reviewLoading"
                                :class="reviewLoading ? 'btn-loading' : ''"
                                class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold uppercase w-full hover:bg-blue-700 transition-all relative">
                            <span class="btn-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</span>
                            <template x-if="reviewLoading">
                                <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                            </template>
                        </button>
                    </div>
                </div>

                <!-- –ó–ê–ö–£–ü–ö–ò –ü–û–í–ê–† -->
                <div x-show="tab == 'ch_buy'">
                    <h2 class="text-2xl font-black mb-6 uppercase">–ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
                    <div class="bg-white p-8 rounded-[2rem] border shadow-sm">
                        <div class="space-y-3">
                            <input x-model="purchaseItem" class="w-full p-4 border rounded-2xl outline-none bg-slate-50 font-bold focus:border-blue-500" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞">
                            <input x-model="purchaseQty" class="w-full p-4 border rounded-2xl outline-none bg-slate-50 font-bold focus:border-blue-500" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 10 –∫–≥)">
                            <input x-model="purchasePrice" type="number" class="w-full p-4 border rounded-2xl outline-none bg-slate-50 font-bold focus:border-blue-500" placeholder="–¶–µ–Ω–∞ (—Ä—É–±)">
                        </div>
                        <button @click="addPurchase()"
                                :disabled="purchaseLoading"
                                :class="purchaseLoading ? 'btn-loading' : ''"
                                class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold uppercase w-full hover:bg-blue-700 mt-4 shadow-lg transition-all relative">
                            <span class="btn-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</span>
                            <template x-if="purchaseLoading">
                                <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                            </template>
                        </button>
                    </div>
                </div>

                <!-- –û–î–û–ë–†–ï–ù–ò–ï –ó–ê–ö–£–ü–û–ö –ê–î–ú–ò–ù -->
                <div x-show="tab == 'ad_approve'">
                    <h2 class="text-2xl font-black mb-6 uppercase">–û–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫</h2>

                    <!-- –°–í–û–î–ö–ê –ü–û –û–ñ–ò–î–ê–Æ–©–ò–ú –ó–ê–ö–£–ü–ö–ê–ú -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 mb-6" x-show="purchases.filter(x => x.status == '–û–∂–∏–¥–∞–µ—Ç').length > 0">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-bold text-slate-600 uppercase">–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è</p>
                                <p class="text-3xl font-black text-blue-600" x-text="purchases.filter(x => x.status == '–û–∂–∏–¥–∞–µ—Ç').length + ' –∑–∞—è–≤–æ–∫'"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-slate-600 uppercase">–û–±—â–∞—è —Å—É–º–º–∞</p>
                                <p class="text-3xl font-black text-orange-600" x-text="purchases.filter(x => x.status == '–û–∂–∏–¥–∞–µ—Ç').reduce((s, p) => s + (p.price || 0), 0) + ' ‚ÇΩ'"></p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <template x-for="p in purchases.filter(x => x.status == '–û–∂–∏–¥–∞–µ—Ç')">
                            <div class="bg-white p-6 rounded-3xl border flex justify-between items-center shadow-sm border-l-8 border-orange-400 hover:shadow-lg transition-all relative overflow-hidden">
                                <!-- –û–í–ï–†–õ–ï–ô "–û–¥–æ–±—Ä–µ–Ω–æ!" -->
                                <div x-show="approvedPurchases[p.id]" class="eaten-overlay" :class="approvedPurchasesExit[p.id] ? 'fade-out' : ''">
                                    <i class="fas fa-check-circle"></i>
                                    <span>–û–¥–æ–±—Ä–µ–Ω–æ!</span>
                                </div>
                                <!-- –û–í–ï–†–õ–ï–ô "–ó–∞–ø—Ä–µ—â–µ–Ω–æ!" -->
                                <div x-show="rejectedPurchases[p.id]" class="eaten-overlay" style="background:linear-gradient(135deg, rgba(220,38,38,0.95), rgba(185,28,28,0.97))" :class="rejectedPurchasesExit[p.id] ? 'fade-out' : ''">
                                    <i class="fas fa-ban"></i>
                                    <span>–ó–∞–ø—Ä–µ—â–µ–Ω–æ!</span>
                                </div>
                                <div class="flex-1">
                                    <b class="text-xl block" x-text="p.item"></b>
                                    <div class="flex gap-4 text-slate-400 text-xs mt-2">
                                        <span><i class="fas fa-box mr-1"></i> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <b x-text="p.qty"></b></span>
                                        <span><i class="fas fa-ruble-sign mr-1"></i> –¶–µ–Ω–∞: <b class="text-orange-600" x-text="(p.price || 0) + ' ‚ÇΩ'"></b></span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="approvePurchase(p)"
                                            :disabled="approvePurchaseLoading == p.id || rejectPurchaseLoading == p.id"
                                            :class="approvePurchaseLoading == p.id ? 'btn-loading' : ''"
                                            class="bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold text-xs uppercase hover:bg-emerald-600 shadow-lg transition-all relative">
                                        <span class="btn-text"><i class="fas fa-check mr-1"></i>–û–¥–æ–±—Ä–∏—Ç—å</span>
                                        <template x-if="approvePurchaseLoading == p.id">
                                            <div class="btn-spinner"><div class="btn-spinner-ring"></div></div>
                                        </template>
                                    </button>
                                    <button @click="rejectPurchase(p)"
                                            :disabled="approvePurchaseLoading == p.id || rejectPurchaseLoading == p.id"
                                            :class="rejectPurchaseLoading == p.id ? 'btn-loading' : ''"
                                            class="bg-red-100 text-red-600 px-6 py-3 rounded-xl font-bold text-xs uppercase hover:bg-red-200 shadow transition-all relative">
                                        <span class="btn-text"><i class="fas fa-ban mr-1"></i>–ó–∞–ø—Ä–µ—Ç–∏—Ç—å</span>
                                        <template x-if="rejectPurchaseLoading == p.id">
                                            <div class="btn-spinner"><div class="btn-spinner-ring" style="border-top-color:#dc2626"></div></div>
                                        </template>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template x-if="purchases.filter(x => x.status == '–û–∂–∏–¥–∞–µ—Ç').length === 0">
                            <div class="text-center py-20 bg-slate-50 rounded-3xl border-2 border-dashed">
                                <i class="fas fa-clipboard-check text-6xl text-slate-300 mb-4"></i>
                                <p class="font-black uppercase text-slate-400">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–∫—É–ø–∫—É</p>
                            </div>
                        </template>
                    </div>

                    <!-- –ò–°–¢–û–†–ò–Ø –ó–ê–ö–£–ü–û–ö (–æ–¥–æ–±—Ä–µ–Ω—ã + –∑–∞–ø—Ä–µ—â–µ–Ω—ã) -->
                    <div x-show="purchases.filter(x => x.status == '–û–¥–æ–±—Ä–µ–Ω–æ' || x.status == '–ó–∞–ø—Ä–µ—â–µ–Ω–æ').length > 0" class="mt-8">
                        <h3 class="text-lg font-black mb-4 uppercase text-slate-600 flex items-center gap-2">
                            <i class="fas fa-history text-slate-400"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—É–ø–æ–∫
                        </h3>
                        <div class="bg-white rounded-3xl border overflow-hidden shadow-sm">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 font-black uppercase text-slate-400 text-[10px]">
                                    <tr>
                                        <th class="p-4">–ü—Ä–æ–¥—É–∫—Ç</th>
                                        <th class="p-4">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th class="p-4 text-right">–°—É–º–º–∞</th>
                                        <th class="p-4 text-center">–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="p in purchases.filter(x => x.status == '–û–¥–æ–±—Ä–µ–Ω–æ' || x.status == '–ó–∞–ø—Ä–µ—â–µ–Ω–æ').slice().reverse()">
                                        <tr class="border-t hover:bg-slate-50 transition-colors">
                                            <td class="p-4 font-bold" x-text="p.item"></td>
                                            <td class="p-4 text-slate-500" x-text="p.qty"></td>
                                            <td class="p-4 text-right font-black text-base" x-text="(p.price || 0) + ' ‚ÇΩ'"></td>
                                            <td class="p-4 text-center">
                                                <span :class="p.status == '–û–¥–æ–±—Ä–µ–Ω–æ' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'"
                                                      class="px-3 py-1 rounded-full text-[10px] font-black uppercase"
                                                      x-text="p.status"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
                <div x-show="tab.includes('notif')">
                    <h2 class="text-2xl font-black mb-6 uppercase">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                    <div class="space-y-3">
                        <template x-for="n in filteredNotifications">
                            <div class="bg-white p-5 rounded-2xl shadow-sm transition-all hover:shadow-md"
                                 :class="getNotifBorderClass(n)">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-3">
                                        <div class="w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0"
                                             :class="getNotifIconBgClass(n)">
                                            <i class="fas text-white text-sm" :class="getNotifIcon(n)"></i>
                                        </div>
                                        <div>
                                            <span class="font-black text-sm block" x-text="n.title"></span>
                                            <p class="text-sm text-slate-500 mt-0.5" x-text="n.text"></p>
                                        </div>
                                    </div>
                                    <span class="text-slate-400 text-[10px] font-bold whitespace-nowrap ml-4" x-text="n.time"></span>
                                </div>
                            </div>
                        </template>
                        <template x-if="filteredNotifications.length === 0">
                            <div class="text-center py-16 text-slate-400">
                                <i class="fas fa-bell text-5xl mb-4 opacity-30"></i>
                                <p class="font-black uppercase">–ü–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                            </div>
                        </template>
                    </div>
                </div>

            </main>
        </div>

        <footer class="bg-white border-t p-4 px-10 flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center font-black text-xs uppercase" x-text="user.username[0]"></div>
                <div>
                    <p class="font-black text-slate-700 uppercase text-[10px] tracking-widest leading-none" x-text="user.username"></p>
                    <p class="text-[9px] text-slate-400 font-bold mt-1" x-text="user.school"></p>
                </div>
            </div>
            <div class="bg-emerald-50 text-emerald-600 px-4 py-2 rounded-xl font-black border border-emerald-100" x-show="user.role == 'student'" x-text="'–ë–∞–ª–∞–Ω—Å: ' + user.balance + ' ‚ÇΩ'"></div>
        </footer>
    </div>

    <script>
        // ===== TOAST –°–ò–°–¢–ï–ú–ê =====
        function showToast(type, title, desc, duration = 3000) {
            const container = document.getElementById('toast-container');
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${icons[type] || icons.info} toast-icon"></i>
                <div class="toast-body">
                    <div class="toast-title">${title}</div>
                    ${desc ? '<div class="toast-desc">' + desc + '</div>' : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        function canteenApp() {
            return {
                user: null, isRegistering: false, showSchoolDropdown: false, adminSecret: '123',
                filterStatus: 'all', filterMenuCategory: 'all',
                moscowSchools: ["–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ656", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1794", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1383", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ2100", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ2098", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1474", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1590", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ597", "–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ158"],
                regData: { username: '', password: '', fullName: '', role: 'student', school: '', grade: '', adminKey: '', phone: '', email: '' },
                users: [], menu: [], orders: [], ingredients: [], purchases: [], reviews: [], notifications: [], subTransactions: [], subscriptionUsage: [],
                tab: '', selectedAllergens: [], allergiesText: '', refillAmount: 500, reviewDish: '', reviewText: '', purchaseItem: '', purchaseQty: '', purchasePrice: '',
                selectedSubType: '', selectedSubDishes: [], useSubLoading: false,
                newIng: { name: '', unit: '' }, newDish: { name: '', price: '', portions: '', type: '–í—Ç–æ—Ä–æ–µ', category: '–û–±–µ–¥', ingredients: '' },
                stat_dishRevenue: 0, stat_subRevenue: 0, stat_attendance: 0, stat_purchaseExpense: 0, stat_totalDishes: 0,
                cardNumber: '', cardHolder: '', cardExpiry: '', cardCVV: '',

                // ===== LOADING STATES =====
                loginLoading: false,
                buyingDish: null,          // ID –±–ª—é–¥–∞ –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∫—É–ø–∞–µ—Ç—Å—è
                confirmingOrder: null,     // ID –∑–∞–∫–∞–∑–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è
                refillLoading: false,
                subLoading: null,          // —Ç–∏–ø –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞
                saveCardLoading: false,
                removeCardLoading: false,
                profileLoading: false,
                addDishLoading: false,
                addIngLoading: false,
                reviewLoading: false,
                purchaseLoading: false,
                approveLoading: null,      // username –ø–æ–≤–∞—Ä–∞
                rejectLoading: null,       // username –ø–æ–≤–∞—Ä–∞
                approvePurchaseLoading: null, // id –∑–∞–∫—É–ø–∫–∏
                rejectPurchaseLoading: null,  // id –∑–∞–∫—É–ø–∫–∏ (–∑–∞–ø—Ä–µ—Ç)
                csvLoading: false,

                // ===== –ö–£–ü–õ–ï–ù–û / –í–´–î–ê–ù–û –û–í–ï–†–õ–ï–ò =====
                boughtDishes: {},          // { menuId: true } ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ö—É–ø–ª–µ–Ω–æ!"
                boughtDishesExit: {},      // { menuId: true } ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è –≤—ã—Ö–æ–¥–∞
                eatenRows: {},             // { orderId: true } ‚Äî "–Ø –ø–æ–µ–ª(–∞)" –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                eatenRowsExit: {},
                issuedRows: {},            // { orderId: true } ‚Äî "–í—ã–¥–∞–Ω–æ!" –¥–ª—è –ø–æ–≤–∞—Ä–∞
                issuedRowsExit: {},
                approvedPurchases: {},     // { purchaseId: true } ‚Äî "–û–¥–æ–±—Ä–µ–Ω–æ!"
                approvedPurchasesExit: {},
                rejectedPurchases: {},     // { purchaseId: true } ‚Äî "–ó–∞–ø—Ä–µ—â–µ–Ω–æ!"
                rejectedPurchasesExit: {},

                navItems: {
                    student: [{id:'st_menu', name:'–ú–µ–Ω—é –¥–Ω—è', icon:'fa-utensils'}, {id:'st_subscription', name:'–ê–±–æ–Ω–µ–º–µ–Ω—Ç', icon:'fa-ticket-alt'}, {id:'st_history', name:'–ó–∞–∫–∞–∑—ã', icon:'fa-history'}, {id:'st_wallet', name:'–ö–æ—à–µ–ª–µ–∫', icon:'fa-wallet'}, {id:'st_card', name:'–ú–æ—è –∫–∞—Ä—Ç–∞', icon:'fa-credit-card'}, {id:'st_notif', name:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', icon:'fa-bell'}, {id:'st_profile', name:'–ê–ª–ª–µ—Ä–≥–∏–∏', icon:'fa-user-circle'}, {id:'st_rev', name:'–û—Ç–∑—ã–≤—ã', icon:'fa-comment-alt'}],
                    chef: [{id:'ch_issue', name:'–û—á–µ—Ä–µ–¥—å', icon:'fa-check-double'}, {id:'ch_stock', name:'–°–∫–ª–∞–¥', icon:'fa-boxes'}, {id:'ch_accounting', name:'–£—á–µ—Ç', icon:'fa-clipboard-list'}, {id:'ch_buy', name:'–ó–∞–∫—É–ø–∫–∏', icon:'fa-truck'}, {id:'ch_notif', name:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', icon:'fa-bell'}],
                    admin: [{id:'ad_stats', name:'–ê–Ω–∞–ª–∏—Ç–∏–∫–∞', icon:'fa-chart-pie'}, {id:'ad_staff', name:'–ü–µ—Ä—Å–æ–Ω–∞–ª', icon:'fa-users-cog'}, {id:'ad_report', name:'–û—Ç—á–µ—Ç—ã', icon:'fa-table'}, {id:'ad_approve', name:'–ó–∞—è–≤–∫–∏', icon:'fa-clipboard-list'}, {id:'ad_notif', name:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', icon:'fa-bell'}]
                },

                get filteredSchools() { return !this.regData.school ? this.moscowSchools : this.moscowSchools.filter(s => s.toLowerCase().includes(this.regData.school.toLowerCase())); },
                get filteredNotifications() {
                    if (!this.user) return [];
                    return this.notifications.filter(n => {
                        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                        if (n.toUser && n.toUser === this.user.username) return true;
                        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ —Ä–æ–ª–∏
                        if (n.toRole && n.toRole === this.user.role) return true;
                        return false;
                    }).reverse();
                },
                get filteredOrders() {
                    if (this.filterStatus === 'all') return this.orders;
                    return this.orders.filter(o => o.status === this.filterStatus);
                },
                get filteredMenu() {
                    if (this.filterMenuCategory === 'all') return this.menu;
                    return this.menu.filter(m => (m.category || '–û–±–µ–¥') === this.filterMenuCategory);
                },

                get hasCard() {
                    return this.user && this.user.cardNumber && this.user.cardNumber.length > 0;
                },

                // ===== –ê–ë–û–ù–ï–ú–ï–ù–¢–´: –•–ï–õ–ü–ï–†–´ =====
                hasActiveSubscription(type) {
                    if (!this.user) return false;
                    return this.subTransactions.some(t => t.user === this.user.username && t.type === type);
                },

                usedSubscriptionToday(type) {
                    if (!this.user) return false;
                    const today = new Date().toISOString().split('T')[0];
                    return this.subscriptionUsage.some(u =>
                        u.user === this.user.username &&
                        u.subType === type &&
                        u.date === today
                    );
                },

                canUseSubscription() {
                    if (!this.selectedSubType || this.selectedSubDishes.length === 0) return false;

                    if (this.selectedSubType === '–ó–∞–≤—Ç—Ä–∞–∫–∏') {
                        // –ù—É–∂–Ω–æ: 1 –±–ª—é–¥–æ + 1 –Ω–∞–ø–∏—Ç–æ–∫
                        const hasDish = this.selectedSubDishes.some(id => {
                            const m = this.menu.find(dish => dish.id === id);
                            return m && (m.type === '–ü–µ—Ä–≤–æ–µ' || m.type === '–í—Ç–æ—Ä–æ–µ');
                        });
                        const hasDrink = this.selectedSubDishes.some(id => {
                            const m = this.menu.find(dish => dish.id === id);
                            return m && m.type === '–ù–∞–ø–∏—Ç–æ–∫';
                        });
                        return hasDish && hasDrink && this.selectedSubDishes.length === 2;
                    }

                    if (this.selectedSubType === '–û–±–µ–¥—ã') {
                        // –ù—É–∂–Ω–æ: 1 –ø–µ—Ä–≤–æ–µ + 1 –≤—Ç–æ—Ä–æ–µ + 1 –Ω–∞–ø–∏—Ç–æ–∫
                        const hasFirst = this.selectedSubDishes.some(id => {
                            const m = this.menu.find(dish => dish.id === id);
                            return m && m.type === '–ü–µ—Ä–≤–æ–µ';
                        });
                        const hasSecond = this.selectedSubDishes.some(id => {
                            const m = this.menu.find(dish => dish.id === id);
                            return m && m.type === '–í—Ç–æ—Ä–æ–µ';
                        });
                        const hasDrink = this.selectedSubDishes.some(id => {
                            const m = this.menu.find(dish => dish.id === id);
                            return m && m.type === '–ù–∞–ø–∏—Ç–æ–∫';
                        });
                        return hasFirst && hasSecond && hasDrink && this.selectedSubDishes.length === 3;
                    }

                    return false;
                },

                toggleSubDish(dishId, dishType) {
                    const idx = this.selectedSubDishes.indexOf(dishId);

                    if (idx > -1) {
                        // –£–±–∏—Ä–∞–µ–º –≤—ã–±–æ—Ä
                        this.selectedSubDishes.splice(idx, 1);
                    } else {
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
                        if (this.selectedSubType === '–ó–∞–≤—Ç—Ä–∞–∫–∏') {
                            // –¢–æ–ª—å–∫–æ 1 –±–ª—é–¥–æ (–ø–µ—Ä–≤–æ–µ –∏–ª–∏ –≤—Ç–æ—Ä–æ–µ) + 1 –Ω–∞–ø–∏—Ç–æ–∫
                            if (dishType === '–ù–∞–ø–∏—Ç–æ–∫') {
                                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –Ω–∞–ø–∏—Ç–æ–∫
                                this.selectedSubDishes = this.selectedSubDishes.filter(id => {
                                    const m = this.menu.find(dish => dish.id === id);
                                    return m && m.type !== '–ù–∞–ø–∏—Ç–æ–∫';
                                });
                            } else {
                                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –±–ª—é–¥–æ
                                this.selectedSubDishes = this.selectedSubDishes.filter(id => {
                                    const m = this.menu.find(dish => dish.id === id);
                                    return m && m.type === '–ù–∞–ø–∏—Ç–æ–∫';
                                });
                            }
                            this.selectedSubDishes.push(dishId);
                        } else if (this.selectedSubType === '–û–±–µ–¥—ã') {
                            // –¢–æ–ª—å–∫–æ 1 –ø–µ—Ä–≤–æ–µ + 1 –≤—Ç–æ—Ä–æ–µ + 1 –Ω–∞–ø–∏—Ç–æ–∫
                            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –±–ª—é–¥–æ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞
                            this.selectedSubDishes = this.selectedSubDishes.filter(id => {
                                const m = this.menu.find(dish => dish.id === id);
                                return m && m.type !== dishType;
                            });
                            this.selectedSubDishes.push(dishId);
                        }
                    }
                },

                // ===== –ú–ê–ü–ü–ò–ù–ì –ê–õ–õ–ï–†–ì–ï–ù–û–í =====
                allergenMapping: {
                    '–ª–∞–∫—Ç–æ–∑–∞': ['–º–æ–ª–æ–∫–æ', '—Å–ª–∏–≤–∫–∏', '—Å–º–µ—Ç–∞–Ω–∞', '–π–æ–≥—É—Ä—Ç', '–∫–µ—Ñ–∏—Ä', '—Ç–≤–æ—Ä–æ–≥', '—Å—ã—Ä', '–º–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ', '—Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ', '–º–æ—Ä–æ–∂–µ–Ω–æ–µ', '—Å–≥—É—â–µ–Ω–∫–∞'],
                    '–æ—Ä–µ—Ö–∏': ['–æ—Ä–µ—Ö', '–∞—Ä–∞—Ö–∏—Å', '–º–∏–Ω–¥–∞–ª—å', '—Ñ—É–Ω–¥—É–∫', '–∫–µ—à—å—é', '–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö', '—Ñ–∏—Å—Ç–∞—à–∫–∏', '–∫–µ–¥—Ä–æ–≤—ã–µ –æ—Ä–µ—Ö–∏'],
                    '–≥–ª—é—Ç–µ–Ω': ['–ø—à–µ–Ω–∏—Ü–∞', '–º—É–∫–∞', '—Ö–ª–µ–±', '–º–∞–∫–∞—Ä–æ–Ω—ã', '–±—É–ª–∫–∞', '–ø–µ—á–µ–Ω—å–µ', '—Ä–æ–∂—å', '—è—á–º–µ–Ω—å', '–æ–≤—ë—Å', '–º–∞–Ω–∫–∞'],
                    '—è–π—Ü–∞': ['—è–π—Ü–æ', '—è–π—Ü–∞', '–∂–µ–ª—Ç–æ–∫', '–±–µ–ª–æ–∫ —è–∏—á–Ω—ã–π', '–º–∞–π–æ–Ω–µ–∑'],
                    '—Ü–∏—Ç—Ä—É—Å': ['–ª–∏–º–æ–Ω', '–∞–ø–µ–ª—å—Å–∏–Ω', '–º–∞–Ω–¥–∞—Ä–∏–Ω', '–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç', '–ª–∞–π–º', '—Ü–∏—Ç—Ä—É—Å'],
                    '–º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã': ['—Ä—ã–±–∞', '–∫—Ä–µ–≤–µ—Ç–∫–∏', '–∫—Ä–∞–±', '–∫–∞–ª—å–º–∞—Ä', '–º–∏–¥–∏–∏', '–æ—Å—å–º–∏–Ω–æ–≥', '–∏–∫—Ä–∞', '–ª–æ—Å–æ—Å—å', '—Ç—É–Ω–µ—Ü', '—Å–µ–º–≥–∞']
                },

                hasAllergen(dish) {
                    if (!this.user || !this.user.allergies || !dish.ingredients) return false;
                    return this.getDetectedAllergens(dish).length > 0;
                },

                getDetectedAllergens(dish) {
                    if (!this.user || !this.user.allergies || !dish.ingredients) return [];
                    const userAllergens = this.user.allergies.toLowerCase().split(',').map(a => a.trim()).filter(a => a);
                    const dishIngredients = dish.ingredients.toLowerCase();
                    const detected = [];
                    userAllergens.forEach(allergen => {
                        if (dishIngredients.includes(allergen)) { detected.push(allergen.toUpperCase()); return; }
                        const ingredientsList = this.allergenMapping[allergen];
                        if (ingredientsList) {
                            const found = ingredientsList.find(ingredient => dishIngredients.includes(ingredient));
                            if (found) detected.push(allergen.toUpperCase());
                        }
                    });
                    return [...new Set(detected)];
                },

                getAllergenList(dish) {
                    return this.getDetectedAllergens(dish).join(', ');
                },

                // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô: –ø–æ–∫–∞–∑–∞—Ç—å –æ–≤–µ—Ä–ª–µ–π –Ω–∞ –≤—Ä–µ–º—è =====
                showOverlay(stateObj, exitObj, key, duration = 1800) {
                    this[stateObj] = { ...this[stateObj], [key]: true };
                    this[exitObj] = { ...this[exitObj], [key]: false };
                    setTimeout(() => {
                        this[exitObj] = { ...this[exitObj], [key]: true };
                        setTimeout(() => {
                            this[stateObj] = { ...this[stateObj], [key]: false };
                            this[exitObj] = { ...this[exitObj], [key]: false };
                        }, 450);
                    }, duration);
                },

                async init() {
                    await this.sync();
                    if (this.user) {
                        const defaultTabs = { student: 'st_menu', chef: 'ch_issue', admin: 'ad_stats' };
                        this.tab = defaultTabs[this.user.role] || this.navItems[this.user.role][0].id;
                        this.loadUserAllergens();
                        this.loadUserCard();
                    }
                    setInterval(() => this.sync(), 10000);
                },

                loadUserAllergens() {
                    if (!this.user || !this.user.allergies) { this.selectedAllergens = []; this.allergiesText = ''; return; }
                    const allAllergens = this.user.allergies.split(',').map(a => a.trim()).filter(a => a);
                    const predefinedList = ['–õ–∞–∫—Ç–æ–∑–∞', '–û—Ä–µ—Ö–∏', '–ì–ª—é—Ç–µ–Ω', '–Ø–π—Ü–∞', '–¶–∏—Ç—Ä—É—Å', '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã'];
                    this.selectedAllergens = [];
                    const otherAllergens = [];
                    allAllergens.forEach(allergen => {
                        const normalized = allergen.charAt(0).toUpperCase() + allergen.slice(1).toLowerCase();
                        if (predefinedList.includes(normalized)) this.selectedAllergens.push(normalized);
                        else otherAllergens.push(allergen);
                    });
                    this.allergiesText = otherAllergens.join(', ');
                },

                loadUserCard() {
                    if (!this.user) return;
                    this.cardNumber = this.user.cardNumber || '';
                    this.cardHolder = this.user.cardHolder || '';
                    this.cardExpiry = this.user.cardExpiry || '';
                    this.cardCVV = '';
                },

                async sync() {
                    try {
                        const r = await fetch('/api/sync');
                        const d = await r.json();
                        this.menu = d.menu;
                        this.orders = d.orders;
                        this.ingredients = d.ingredients;
                        this.users = d.users;
                        this.reviews = d.reviews;
                        this.purchases = d.purchases;
                        this.notifications = d.notifications;
                        this.subTransactions = d.subTransactions;
                        this.subscriptionUsage = d.subscriptionUsage;
                        if(this.user) {
                            let found = this.users.find(u => u.username === this.user.username);
                            if(found) {
                                const oldAllergies = this.user.allergies;
                                this.user = found;
                                if (oldAllergies !== this.user.allergies) this.loadUserAllergens();
                            }
                        }
                        this.calculateStats();
                    } catch (error) {
                        console.error("[SYNC] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", error);
                    }
                },

                // ===== –í–û–ô–¢–ò / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø =====
                async login() {
                    if (!this.regData.username || !this.regData.password) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
                        return;
                    }
                    this.loginLoading = true;
                    try {
                        const r = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:this.regData.username, password:this.regData.password})});
                        const d = await r.json();
                        if(d.error) {
                            showToast('error', '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', d.error);
                            this.loginLoading = false;
                            return;
                        }
                        this.user = d;
                        this.tab = this.navItems[this.user.role][0].id;
                        this.loadUserAllergens();
                        this.loadUserCard();
                        await this.sync();
                        showToast('success', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ' + this.user.fullName);
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                    }
                    this.loginLoading = false;
                },

                async register() {
                    if(this.regData.role === 'admin' && this.regData.adminKey !== this.adminSecret) {
                        showToast('error', '–û—à–∏–±–∫–∞', 'ROOT-–∫–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π!');
                        return;
                    }
                    if (!this.regData.username || !this.regData.password || !this.regData.fullName) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                        return;
                    }
                    this.loginLoading = true;
                    try {
                        const r = await fetch('/api/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.regData)});
                        const d = await r.json();
                        if(d.error) {
                            showToast('error', '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', d.error);
                            this.loginLoading = false;
                            return;
                        }
                        showToast('success', '–£—Å–ø–µ—à–Ω–æ!', '–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥—ë—Ç–µ.');
                        this.isRegistering = false;
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    }
                    this.loginLoading = false;
                },

                // ===== –ö–£–ü–ò–¢–¨ –ë–õ–Æ–î–û =====
                async buy(m) {
                    if(this.user.balance < m.price) {
                        showToast('error', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', '–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –≤ –∫–æ—à–µ–ª—ë–∫–µ');
                        return;
                    }
                    if(this.hasAllergen(m)) {
                        const allergensList = this.getDetectedAllergens(m).join(', ');
                        const confirmed = confirm(
                            `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –û–ü–ê–°–ù–û–°–¢–¨ –î–õ–Ø –ó–î–û–†–û–í–¨–Ø!\n\n–≠—Ç–æ –±–ª—é–¥–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–ª–ª–µ—Ä–≥–µ–Ω—ã:\nüî¥ ${allergensList}\n\n–£–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∞–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫—É—é —Ä–µ–∞–∫—Ü–∏—é!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å –µ–≥–æ?`
                        );
                        if(!confirmed) return;
                    }

                    this.buyingDish = m.id;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'buy', user:this.user.username, menuId:m.id, allergies:this.user.allergies})});
                        const d = await r.json();
                        if (d.ok) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ö—É–ø–ª–µ–Ω–æ!" –æ–≤–µ—Ä–ª–µ–π
                            this.showOverlay('boughtDishes', 'boughtDishesExit', m.id, 1800);
                            showToast('success', '–ö—É–ø–ª–µ–Ω–æ!', m.name + ' ‚Äî ' + m.price + ' ‚ÇΩ');
                        } else {
                            showToast('error', '–û—à–∏–±–∫–∞', d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å');
                        }
                        await this.sync();
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∫—É–ø–∫—É');
                    }
                    this.buyingDish = null;
                },

                // ===== "–Ø –ø–æ–µ–ª(–∞)" ‚Äî —É—á–µ–Ω–∏–∫ =====
                async confirmOrderStudent(id) {
                    this.confirmingOrder = id;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'confirm_order', id:id})});
                        const d = await r.json();
                        if (d.ok) {
                            this.showOverlay('eatenRows', 'eatenRowsExit', id, 1500);
                            showToast('success', '–û—Ç–º–µ—á–µ–Ω–æ!', '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω');
                        }
                        await this.sync();
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å');
                    }
                    this.confirmingOrder = null;
                },

                // ===== "–í—ã–¥–∞—Ç—å" ‚Äî –ø–æ–≤–∞—Ä =====
                async confirmOrderChef(id) {
                    this.confirmingOrder = id;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'confirm_order', id:id})});
                        const d = await r.json();
                        if (d.ok) {
                            this.showOverlay('issuedRows', 'issuedRowsExit', id, 1500);
                            showToast('success', '–í—ã–¥–∞–Ω–æ!', '–ó–∞–∫–∞–∑ ‚Ññ' + id + ' –ø–µ—Ä–µ–¥–∞–Ω —É—á–µ–Ω–∏–∫—É');
                        }
                        await this.sync();
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –∑–∞–∫–∞–∑');
                    }
                    this.confirmingOrder = null;
                },

                // ===== –ê–ë–û–ù–ï–ú–ï–ù–¢ =====
                async buySub(type, price) {
                    if(this.user.balance < price) {
                        showToast('error', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', '–ù—É–∂–Ω–æ: ' + price + ' ‚ÇΩ, –µ—Å—Ç—å: ' + this.user.balance + ' ‚ÇΩ');
                        return;
                    }
                    this.subLoading = type;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'buy_sub', user:this.user.username, subType:type, price:price})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–ê–±–æ–Ω–µ–º–µ–Ω—Ç –∫—É–ø–ª–µ–Ω!', type + ' ‚Äî ' + price + ' ‚ÇΩ');
                        }
                        await this.sync();
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç');
                    }
                    this.subLoading = null;
                },

                // ===== –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ê–ë–û–ù–ï–ú–ï–ù–¢ =====
                async useSubscription() {
                    if (!this.canUseSubscription()) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–ª—é–¥–∞');
                        return;
                    }
                    this.useSubLoading = true;
                    try {
                        const r = await fetch('/api/action', {
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({
                                type:'use_subscription',
                                user: this.user.username,
                                subType: this.selectedSubType,
                                dishes: this.selectedSubDishes,
                                allergies: this.user.allergies
                            })
                        });
                        const d = await r.json();
                        if (d.error) {
                            showToast('error', '–û—à–∏–±–∫–∞', d.error);
                        } else if (d.ok) {
                            showToast('success', '–ì–æ—Ç–æ–≤–æ!', '–í–∞—à–∏ –±–ª—é–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å');
                            this.selectedSubDishes = [];
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç');
                    }
                    this.useSubLoading = false;
                },

                // ===== –ü–û–ü–û–õ–ù–ò–¢–¨ –ë–ê–õ–ê–ù–° =====
                async refill() {
                    if (!this.hasCard) {
                        showToast('warning', '–ö–∞—Ä—Ç–∞ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞', '–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –∫–∞—Ä—Ç—É –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ú–æ—è –∫–∞—Ä—Ç–∞"');
                        return;
                    }
                    if (!this.refillAmount || this.refillAmount <= 0) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                        return;
                    }
                    this.refillLoading = true;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'refill', user:this.user.username, amount:parseInt(this.refillAmount)})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!', '+' + this.refillAmount + ' ‚ÇΩ');
                            this.refillAmount = 500;
                        }
                        await this.sync();
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å');
                    }
                    this.refillLoading = false;
                },

                // ===== –°–û–•–†–ê–ù–ò–¢–¨ –ö–ê–†–¢–£ =====
                async saveCard() {
                    if (!this.cardNumber || !this.cardHolder || !this.cardExpiry || !this.cardCVV) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–∞—Ä—Ç—ã');
                        return;
                    }
                    const cleanCardNumber = this.cardNumber.replace(/\s/g, '');
                    if (cleanCardNumber.length !== 16 || !/^\d+$/.test(cleanCardNumber)) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 16 —Ü–∏—Ñ—Ä');
                        return;
                    }
                    if (!/^\d{2}\/\d{2}$/.test(this.cardExpiry)) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YY');
                        return;
                    }
                    if (this.cardCVV.length !== 3 || !/^\d+$/.test(this.cardCVV)) {
                        showToast('error', '–û—à–∏–±–∫–∞', 'CVV –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 3 —Ü–∏—Ñ—Ä—ã');
                        return;
                    }

                    this.saveCardLoading = true;
                    try {
                        const r = await fetch('/api/action', {
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({ type:'save_card', user:this.user.username, cardNumber: cleanCardNumber, cardHolder: this.cardHolder, cardExpiry: this.cardExpiry })
                        });
                        const d = await r.json();
                        if (d.ok) {
                            this.cardCVV = '';
                            await this.sync();
                            showToast('success', '–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞!', '**** **** **** ' + cleanCardNumber.slice(-4));
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É');
                    }
                    this.saveCardLoading = false;
                },

                // ===== –£–î–ê–õ–ò–¢–¨ –ö–ê–†–¢–£ =====
                async removeCard() {
                    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É?")) return;
                    this.removeCardLoading = true;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'remove_card', user:this.user.username})});
                        const d = await r.json();
                        if (d.ok) {
                            this.cardNumber = ''; this.cardHolder = ''; this.cardExpiry = ''; this.cardCVV = '';
                            await this.sync();
                            showToast('success', '–ö–∞—Ä—Ç–∞ —É–¥–∞–ª–µ–Ω–∞', '–ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–Ω–∞');
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É');
                    }
                    this.removeCardLoading = false;
                },

                formatCardNumber(value) {
                    const cleaned = value.replace(/\s/g, '');
                    const chunks = cleaned.match(/.{1,4}/g);
                    return chunks ? chunks.join(' ') : cleaned;
                },

                // ===== –û–î–û–ë–†–ò–¢–¨ / –û–¢–ö–õ–û–ù–ò–¢–¨ –ü–û–í–ê–†–ê =====
                async approveChef(un) {
                    this.approveLoading = un;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'approve_chef', target:un})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–ü–æ–≤–∞—Ä –æ–¥–æ–±—Ä–µ–Ω!', un);
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–æ–±—Ä–∏—Ç—å');
                    }
                    this.approveLoading = null;
                },

                async rejectChef(un) {
                    if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–≤–∞—Ä–∞ " + un + "?")) return;
                    this.rejectLoading = un;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'reject_chef', target:un})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞', '–ü–æ–≤–∞—Ä ' + un + ' —É–¥–∞–ª—ë–Ω');
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
                    }
                    this.rejectLoading = null;
                },

                // ===== –û–ë–ù–û–í–ò–¢–¨ –ü–û–†–¶–ò–ò =====
                async updateStock(m, delta) {
                    const newPortions = Math.max(0, m.portions + delta);
                    try {
                        await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'update_stock', id:m.id, val: newPortions})});
                        await this.sync();
                    } catch (e) { showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å'); }
                },

                // ===== –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´ =====
                async setIng(i) {
                    try {
                        await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'set_ing', id:i.id, val: i.amount})});
                        await this.sync();
                    } catch (e) { showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å'); }
                },

                async addNewIngredient() {
                    if (!this.newIng.name || !this.newIng.unit) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è');
                        return;
                    }
                    this.addIngLoading = true;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'add_ing', name:this.newIng.name, unit:this.newIng.unit})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!', this.newIng.name);
                            this.newIng = {name:'', unit:''};
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å');
                    }
                    this.addIngLoading = false;
                },

                // ===== –î–û–ë–ê–í–ò–¢–¨ –ë–õ–Æ–î–û =====
                async addNewDish() {
                    if(!this.newDish.name || !this.newDish.price) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É');
                        return;
                    }
                    if(!this.newDish.ingredients) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–£–∫–∞–∂–∏—Ç–µ —Å–æ—Å—Ç–∞–≤ –±–ª—é–¥–∞');
                        return;
                    }
                    this.addDishLoading = true;
                    try {
                        const r = await fetch('/api/action', {
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({
                                type:'add_menu_item',
                                name:this.newDish.name,
                                price:parseFloat(this.newDish.price),
                                portions:parseInt(this.newDish.portions) || 0,
                                dishType:this.newDish.type,
                                category:this.newDish.category,
                                ingredients:this.newDish.ingredients
                            })
                        });
                        const result = await r.json();
                        if(result.ok) {
                            showToast('success', '–ë–ª—é–¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', this.newDish.name + ' ‚Äî —Ç–µ–ø–µ—Ä—å –≤–∏–¥–Ω–æ –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º');
                            this.newDish = { name: '', price: '', portions: '', type: '–í—Ç–æ—Ä–æ–µ', category: '–û–±–µ–¥', ingredients: '' };
                            await this.sync();
                        } else {
                            showToast('error', '–û—à–∏–±–∫–∞', result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ');
                    }
                    this.addDishLoading = false;
                },

                // ===== –û–¢–ó–´–í =====
                async addReview() {
                    if (!this.reviewDish || !this.reviewText) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–æ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
                        return;
                    }
                    this.reviewLoading = true;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'add_review', dish:this.reviewDish, text:this.reviewText, author:this.user.fullName})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ');
                            this.reviewText = '';
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤');
                    }
                    this.reviewLoading = false;
                },

                // ===== –ó–ê–ö–£–ü–ö–ê =====
                async addPurchase() {
                    if (!this.purchaseItem || !this.purchaseQty || !this.purchasePrice) {
                        showToast('warning', '–í–Ω–∏–º–∞–Ω–∏–µ', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                        return;
                    }
                    this.purchaseLoading = true;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'add_purchase', item:this.purchaseItem, qty:this.purchaseQty, price:parseFloat(this.purchasePrice)})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!', this.purchaseItem + ' ‚Äî ' + this.purchasePrice + ' ‚ÇΩ');
                            this.purchaseItem = ''; this.purchaseQty = ''; this.purchasePrice = '';
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É');
                    }
                    this.purchaseLoading = false;
                },

                // ===== –û–î–û–ë–†–ò–¢–¨ –ó–ê–ö–£–ü–ö–£ =====
                async approvePurchase(p) {
                    this.approvePurchaseLoading = p.id;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'approve_purchase', id:p.id})});
                        const d = await r.json();
                        if (d.ok) {
                            this.showOverlay('approvedPurchases', 'approvedPurchasesExit', p.id, 1500);
                            showToast('success', '–ó–∞–∫—É–ø–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!', p.item + ' ‚Äî ' + (p.price || 0) + ' ‚ÇΩ');
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–æ–±—Ä–∏—Ç—å');
                    }
                    this.approvePurchaseLoading = null;
                },

                // ===== –ó–ê–ü–†–ï–¢–ò–¢–¨ –ó–ê–ö–£–ü–ö–£ =====
                async rejectPurchase(p) {
                    this.rejectPurchaseLoading = p.id;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'reject_purchase', id:p.id})});
                        const d = await r.json();
                        if (d.ok) {
                            this.showOverlay('rejectedPurchases', 'rejectedPurchasesExit', p.id, 1500);
                            showToast('warning', '–ó–∞–∫—É–ø–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞', p.item + ' ‚Äî –∑–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—Ä–µ—Ç–∏—Ç—å');
                    }
                    this.rejectPurchaseLoading = null;
                },

                // ===== –ü–†–û–§–ò–õ–¨ / –ê–õ–õ–ï–†–ì–ò–ò =====
                async saveProfile() {
                    let comb = [...this.selectedAllergens];
                    if(this.allergiesText.trim()) {
                        const textAllergens = this.allergiesText.trim().split(',').map(a => a.trim()).filter(a => a);
                        comb.push(...textAllergens);
                    }
                    const allergiesString = comb.join(', ');
                    this.profileLoading = true;
                    try {
                        const r = await fetch('/api/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'save_profile', user:this.user.username, allergies:allergiesString})});
                        const d = await r.json();
                        if (d.ok) {
                            showToast('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', '–ê–ª–ª–µ—Ä–≥–µ–Ω—ã: ' + (allergiesString || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'));
                            await this.sync();
                        }
                    } catch (e) {
                        showToast('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
                    }
                    this.profileLoading = false;
                },

                // ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê =====
                calculateStats() {
                    this.stat_dishRevenue = this.orders.reduce((s,o) => s + (o.status === '–í—ã–¥–∞–Ω–æ' ? o.price : 0), 0);
                    this.stat_subRevenue = this.subTransactions.reduce((s,t) => s + t.amount, 0);
                    this.stat_purchaseExpense = this.purchases.reduce((s,p) => s + (p.status === '–û–¥–æ–±—Ä–µ–Ω–æ' ? (p.price || 0) : 0), 0);
                    this.stat_attendance = this.orders.length ? Math.round((this.orders.filter(o => o.status === '–í—ã–¥–∞–Ω–æ').length / this.orders.length) * 100) : 0;
                    this.stat_totalDishes = this.orders.filter(o => o.status === '–í—ã–¥–∞–Ω–æ').length;
                },

                isNewDish(addedDate) {
                    if (!addedDate) return false;
                    return (new Date() - new Date(addedDate)) / 3600000 < 24;
                },

                formatDate(isoDate) {
                    if (!isoDate) return '–°–µ–≥–æ–¥–Ω—è';
                    return new Date(isoDate).toLocaleDateString('ru-RU');
                },

                getUserClass(username) {
                    const u = this.users.find(u => u.username === username);
                    return u ? u.grade + ' –∫–ª' : '-';
                },

                getDishType(name) {
                    const m = this.menu.find(m => m.name === name);
                    return m ? m.type : '-';
                },

                // ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø: –∏–∫–æ–Ω–∫–∏ –∏ —Ü–≤–µ—Ç–∞ =====
                getNotifBorderClass(n) {
                    const t = (n.title || '').toLowerCase();
                    if (t.includes('–æ–¥–æ–±—Ä–µ–Ω')) return 'border border-emerald-200 border-l-4 border-l-emerald-500';
                    if (t.includes('–∑–∞–ø—Ä–µ—â') || t.includes('–æ—Ç–∫–ª–æ–Ω')) return 'border border-red-200 border-l-4 border-l-red-500';
                    if (t.includes('–Ω–æ–≤–æ–µ') || t.includes('–¥–æ–±–∞–≤–ª–µ–Ω')) return 'border border-blue-200 border-l-4 border-l-blue-500';
                    if (t.includes('–æ–ø–ª–∞—Ç') || t.includes('–∫—É–ø–ª') || t.includes('–±–∞–ª–∞–Ω—Å')) return 'border border-orange-200 border-l-4 border-l-orange-500';
                    return 'border border-slate-200 border-l-4 border-l-blue-500';
                },
                getNotifIconBgClass(n) {
                    const t = (n.title || '').toLowerCase();
                    if (t.includes('–æ–¥–æ–±—Ä–µ–Ω')) return 'bg-emerald-500';
                    if (t.includes('–∑–∞–ø—Ä–µ—â') || t.includes('–æ—Ç–∫–ª–æ–Ω')) return 'bg-red-500';
                    if (t.includes('–Ω–æ–≤–æ–µ') || t.includes('–¥–æ–±–∞–≤–ª–µ–Ω')) return 'bg-blue-500';
                    if (t.includes('–æ–ø–ª–∞—Ç') || t.includes('–∫—É–ø–ª') || t.includes('–±–∞–ª–∞–Ω—Å')) return 'bg-orange-500';
                    return 'bg-blue-500';
                },
                getNotifIcon(n) {
                    const t = (n.title || '').toLowerCase();
                    if (t.includes('–æ–¥–æ–±—Ä–µ–Ω')) return 'fa-check-circle';
                    if (t.includes('–∑–∞–ø—Ä–µ—â') || t.includes('–æ—Ç–∫–ª–æ–Ω')) return 'fa-ban';
                    if (t.includes('–Ω–æ–≤–æ–µ') || t.includes('–¥–æ–±–∞–≤–ª–µ–Ω')) return 'fa-utensils';
                    if (t.includes('–æ–ø–ª–∞—Ç') || t.includes('–∫—É–ø–ª') || t.includes('–±–∞–ª–∞–Ω—Å')) return 'fa-wallet';
                    return 'fa-bell';
                },

                // ===== –°–ö–ê–ß–ê–¢–¨ CSV =====
                downloadCSVReport() {
                    this.csvLoading = true;
                    setTimeout(() => {
                        const totalIncome = this.stat_dishRevenue + this.stat_subRevenue;
                        const totalExpense = this.stat_purchaseExpense;
                        const profit = totalIncome - totalExpense;

                        let csv = "–§–ò–ù–ê–ù–°–û–í–´–ô –û–¢–ß–Å–¢ –°–¢–û–õ–û–í–û–ô\n";
                        csv += "–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è;" + new Date().toLocaleDateString('ru-RU') + "\n\n";
                        csv += "–§–ò–ù–ê–ù–°–û–í–ê–Ø –°–í–û–î–ö–ê\n";
                        csv += "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å;–ó–Ω–∞—á–µ–Ω–∏–µ\n";
                        csv += "–ü–æ–ª—É—á–µ–Ω–æ (–≤—Å–µ–≥–æ);" + totalIncome + " ‚ÇΩ\n";
                        csv += "–ó–∞—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ –∑–∞–∫—É–ø–∫–∏;" + totalExpense + " ‚ÇΩ\n";
                        csv += "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å;" + profit + " ‚ÇΩ\n";
                        csv += "–ë–ª—é–¥ –ø—Ä–æ–¥–∞–Ω–æ (—à—Ç);" + this.stat_totalDishes + "\n";
                        csv += "–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (%);" + this.stat_attendance + "%\n\n";

                        csv += "–ò–°–¢–û–ß–ù–ò–ö–ò –î–û–•–û–î–ê\n";
                        csv += "–ò—Å—Ç–æ—á–Ω–∏–∫;–°—É–º–º–∞\n";
                        csv += "–ü—Ä–æ–¥–∞–∂–∞ –±–ª—é–¥;" + this.stat_dishRevenue + " ‚ÇΩ\n";
                        csv += "–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã;" + this.stat_subRevenue + " ‚ÇΩ\n";
                        csv += "–ò–¢–û–ì–û –î–û–•–û–î;" + totalIncome + " ‚ÇΩ\n\n";

                        csv += "–†–ê–°–•–û–î–´\n";
                        csv += "–ö–∞—Ç–µ–≥–æ—Ä–∏—è;–°—É–º–º–∞\n";
                        csv += "–ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤;" + totalExpense + " ‚ÇΩ\n";
                        csv += "–û–¥–æ–±—Ä–µ–Ω–æ –∑–∞—è–≤–æ–∫ (—à—Ç);" + this.purchases.filter(p => p.status === '–û–¥–æ–±—Ä–µ–Ω–æ').length + "\n\n";

                        csv += "–î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–ö–ê–ó–û–í\n";
                        csv += "–î–∞—Ç–∞;–£—á–µ–Ω–∏–∫;–ö–ª–∞—Å—Å;–ë–ª—é–¥–æ;–¶–µ–Ω–∞;–°—Ç–∞—Ç—É—Å\n";
                        csv += this.orders.map(o => {
                            const user = this.users.find(u => u.username === o.user);
                            const grade = user ? user.grade : '-';
                            return `${this.formatDate(o.createdAt)};${o.user};${grade};${o.name};${o.price};${o.status}`;
                        }).join("\n");

                        csv += "\n\n";
                        csv += "–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –°–¢–ê–¢–£–°–ê–ú\n";
                        csv += "–°—Ç–∞—Ç—É—Å;–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ;–°—É–º–º–∞\n";
                        const issued = this.orders.filter(o => o.status === '–í—ã–¥–∞–Ω–æ');
                        const paid = this.orders.filter(o => o.status === '–û–ø–ª–∞—á–µ–Ω–æ');
                        csv += "–í—ã–¥–∞–Ω–æ;" + issued.length + ";" + issued.reduce((s, o) => s + o.price, 0) + " ‚ÇΩ\n";
                        csv += "–û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏;" + paid.length + ";" + paid.reduce((s, o) => s + o.price, 0) + " ‚ÇΩ\n";
                        csv += "–í–°–ï–ì–û;" + this.orders.length + ";" + this.orders.reduce((s, o) => s + o.price, 0) + " ‚ÇΩ\n";

                        const date = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
                        const link = document.createElement("a");
                        link.setAttribute("href", "data:text/csv;charset=utf-8,\uFEFF" + encodeURIComponent(csv));
                        link.setAttribute("download", `–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π_–æ—Ç—á–µ—Ç_${date}.csv`);
                        link.click();

                        showToast('success', '–û—Ç—á—ë—Ç —Å–∫–∞—á–∞–Ω!', `–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π_–æ—Ç—á–µ—Ç_${date}.csv`);
                        this.csvLoading = false;
                    }, 600); // –º–∞–ª–µ–Ω—å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã spinner –ø–æ–∫–∞–∑–∞–ª—Å—è
                },

                logout() {
                    this.user = null;
                    showToast('info', '–í—ã –≤—ã—à–ª–∏', '–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!');
                }
            }
        }
    </script>
</body>
</html>